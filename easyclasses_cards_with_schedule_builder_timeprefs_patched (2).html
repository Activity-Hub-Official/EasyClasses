<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EasyClasses SJU • Spring 2026 Class Finder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Primary Meta Tags -->
  <meta name="title" content="EasyClasses SJU • Spring 2026 Class Finder" />
  <meta name="description" content="Browse sections, professor difficulty, and waitlist odds in a friendlier view than Banner, then auto-build an easier schedule that fits your time preferences." />

  <!-- Favicon -->
  <link rel="icon" href="https://i.imgur.com/ZhBld9W.png" type="image/png" />
  <link rel="apple-touch-icon" href="https://i.imgur.com/ZhBld9W.png" />

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://easyclasses.example.com/" />
  <meta property="og:title" content="EasyClasses SJU • Spring 2026 Class Finder" />
  <meta property="og:description" content="Browse sections, professor difficulty, and waitlist odds in a friendlier view than Banner, then auto-build an easier schedule that fits your time preferences." />
  <meta property="og:image" content="https://i.imgur.com/7WmQ0kb.png" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:url" content="https://easyclasses.example.com/" />
  <meta name="twitter:title" content="EasyClasses SJU • Spring 2026 Class Finder" />
  <meta name="twitter:description" content="Browse sections, professor difficulty, and waitlist odds in a friendlier view than Banner, then auto-build an easier schedule that fits your time preferences." />
  <meta name="twitter:image" content="https://i.imgur.com/7WmQ0kb.png" />



  <!-- Google Font: Poppins -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Poppins', 'system-ui', 'sans-serif']
          },
          colors: {
            brand: {
              50: '#eef4ff',
              100: '#e0ecff',
              500: '#2563eb',
              600: '#1d4ed8',
              700: '#1e40af'
            }
          }
        }
      }
    }
  </script>

  <!-- Font Awesome -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />

  <style>
    body { font-family: 'Poppins', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    .chip-active {
      background: #1d4ed8;
      color: #f9fafb;
      box-shadow: 0 8px 16px rgba(15, 23, 42, 0.18);
    }

  /* --- AI Chat visibility + custom scrollbars --- */

  /* Stronger heading/subtitle color for AI Chat */
  [data-page-panel="ai-chat"] h1 {
    color: #0f172a; /* slate-900 */
    opacity: 1;
  }
  [data-page-panel="ai-chat"] p.ai-chat-subtitle {
    color: #64748b; /* slate-500/600 */
    opacity: 1;
  }

  /* Custom scrollbar for AI chat scroll area (inner only) */
  
  .ai-chat-scroll {
    scrollbar-width: none; /* Firefox: hide scrollbar but keep scroll */
  }
  .ai-chat-scroll::-webkit-scrollbar {
    width: 0;
    height: 0;
  }
  .ai-chat-scroll::-webkit-scrollbar-track {
    background: transparent;
  }
  .ai-chat-scroll::-webkit-scrollbar-thumb {
    background: transparent;
  }

/* Desktop-only window scrollbar + composer behavior in AI Chat */
  @media (min-width: 1024px) {
    html.ai-chat-mode,
    body.ai-chat-mode {
      overflow-y: hidden;
    }

    body.ai-chat-mode .ai-chat-composer {
      position: fixed;
      left: 16rem; /* match lg sidebar w-64 */
      right: 0;
      bottom: 0;
      width: calc(100% - 16rem);
      z-index: 60;
      background: transparent;
      padding-bottom: env(safe-area-inset-bottom);
    }
  }

  /* Smooth enter animation for new AI assistant messages */
  @keyframes aiMessageIn {
    0% {
      opacity: 0;
      transform: translateY(6px) scale(0.99);
    }
    100% {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  .ai-msg-enter {
    animation: aiMessageIn 0.16s ease-out;
    animation-fill-mode: both;
  }

</style>

  <!-- PDF.js for advisement sheet reading -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
  </script>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>
<body class="min-h-screen bg-gradient-to-b from-slate-50 via-slate-50 to-slate-100 text-slate-900">
    <!-- Sidebar Layout -->
  <div class="min-h-screen flex flex-col lg:flex-row">
    <!-- Mobile top bar -->
    <header class="lg:hidden sticky top-0 z-40 bg-slate-950/90 backdrop-blur border-b border-slate-800/80 flex items-center justify-between px-4 py-2">
      <div class="flex items-center gap-2">
        <div class="h-8 w-8 rounded-xl overflow-hidden ring-1 ring-slate-700/70">
          <img
            src="https://i.imgur.com/ZhBld9W.png"
            alt="EasyClasses logo"
            class="h-full w-full object-cover"
          />
        </div>
        <div class="flex flex-col">
          <span class="text-sm font-semibold text-slate-50">
            EasyClasses SJU
          </span>
          <span class="text-[11px] text-slate-400">
            Spring 2026 Tools
          </span>
        </div>
      </div>
      <button
        id="mobileNavToggle"
        type="button"
        class="inline-flex items-center gap-1 rounded-full border border-slate-700 bg-slate-900/80 px-3 py-1.5 text-[11px] font-medium text-slate-100 shadow-sm"
      >
        <i class="fa-solid fa-bars text-xs"></i>
        <span>Menu</span>
      </button>
    </header>

    <!-- Mobile nav drawer -->
    <nav
      id="mobileNav"
      class="lg:hidden fixed inset-0 z-40 bg-slate-950/95 backdrop-blur-sm border-b border-slate-800/80
             transform -translate-y-full opacity-0 pointer-events-none
             transition-transform transition-opacity duration-200 ease-out"
    >
      <div class="relative max-w-md mx-auto h-full flex flex-col">
        <div class="flex items-center justify-between px-4 pt-4 pb-2">
          <span class="text-xs font-medium tracking-wide text-slate-300 uppercase">
            Menu
          </span>
          <button
            id="mobileNavClose"
            type="button"
            class="inline-flex items-center justify-center rounded-full border border-slate-700/70
                   bg-slate-900/80 p-2 text-slate-100 shadow-sm hover:bg-slate-800/80"
          >
            <i class="fa-solid fa-xmark text-sm"></i>
            <span class="sr-only">Close menu</span>
          </button>
        </div>

        <div class="px-4 pb-6 pt-2 space-y-1 overflow-y-auto">

        <a href="?page=home"
           data-nav="home"
           class="flex items-center gap-2 px-3 py-2 rounded-lg text-sm text-slate-200 hover:bg-white/5">
          <i class="fa-solid fa-house text-xs opacity-75"></i>
          <span>Overview</span>
        </a>
        <a href="?page=course-search"
           data-nav="course-search"
           class="flex items-center gap-2 px-3 py-2 rounded-lg text-sm text-slate-200 hover:bg-white/5">
          <i class="fa-solid fa-magnifying-glass text-xs opacity-75"></i>
          <span>Course Search</span>
        </a>
        <a href="?page=schedule-builder"
           data-nav="schedule-builder"
           class="flex items-center gap-2 px-3 py-2 rounded-lg text-sm text-slate-200 hover:bg-white/5">
          <i class="fa-solid fa-table-list text-xs opacity-75"></i>
          <span>Schedule Builder</span>
        </a>
        <a href="?page=schedule-optimizer"
           data-nav="schedule-optimizer"
           class="flex items-center gap-2 px-3 py-2 rounded-lg text-sm text-slate-200 hover:bg-white/5">
          <i class="fa-solid fa-wand-magic-sparkles text-xs opacity-75"></i>
          <span>Schedule Optimizer</span>
        </a>
        <a href="?page=ai-chat"
           data-nav="ai-chat"
           class="flex items-center gap-2 px-3 py-2 rounded-lg text-sm text-slate-200 hover:bg-white/5">
          <i class="fa-solid fa-comments text-xs opacity-75"></i>
          <span>AI Chat</span>
        </a>

        </div>
      </div>    </nav>

    <aside class="hidden lg:flex w-64 flex flex-col border-r border-slate-800 bg-slate-950/90 backdrop-blur sticky top-0 h-screen">
      <div class="px-4 py-4 flex items-center gap-3 border-b border-slate-800/80">
        <div class="h-9 w-9 rounded-xl overflow-hidden ring-1 ring-slate-700/70 shadow-sm">
          <img
            src="https://i.imgur.com/ZhBld9W.png"
            alt="EasyClasses logo"
            class="h-full w-full object-cover"
          />
        </div>
        <div class="flex flex-col">
          <span class="text-sm font-semibold tracking-tight text-slate-50">
            EasyClasses SJU
          </span>
          <span class="text-[11px] text-slate-400">
            Spring 2026 Tools
          </span>
        </div>
      </div>

      <nav class="flex-1 px-3 py-3 space-y-1 text-sm font-medium">
        <a href="?page=home"
           data-nav="home"
           class="flex items-center gap-2 px-3 py-2 rounded-lg text-slate-300 hover:text-white hover:bg-white/5 transition-colors">
          <i class="fa-solid fa-house text-xs opacity-80"></i>
          <span>Home</span>
        </a>
        <a href="?page=course-search"
           data-nav="course-search"
           class="flex items-center gap-2 px-3 py-2 rounded-lg text-slate-300 hover:text-white hover:bg-white/5 transition-colors">
          <i class="fa-solid fa-magnifying-glass text-xs opacity-80"></i>
          <span>Course Search</span>
        </a>
        <a href="?page=schedule-builder"
           data-nav="schedule-builder"
           class="flex items-center gap-2 px-3 py-2 rounded-lg text-slate-300 hover:text-white hover:bg-white/5 transition-colors">
          <i class="fa-solid fa-calendar-plus text-xs opacity-80"></i>
          <span>Schedule Builder</span>
        </a>
        <a href="?page=schedule-optimizer"
           data-nav="schedule-optimizer"
           class="flex items-center gap-2 px-3 py-2 rounded-lg text-slate-300 hover:text-white hover:bg-white/5 transition-colors">
          <i class="fa-solid fa-wand-magic-sparkles text-xs opacity-80"></i>
          <span>Schedule Optimizer</span>
        </a>
        <a href="?page=ai-chat"
           data-nav="ai-chat"
           class="flex items-center gap-2 px-3 py-2 rounded-lg text-slate-300 hover:text-white hover:bg-white/5 transition-colors">
          <i class="fa-solid fa-comments text-xs opacity-80"></i>
          <span>AI Chat</span>
        </a>
      </nav>

      <div class="px-3 pb-4 pt-2 border-t border-slate-800/80">
        <span class="inline-flex items-center justify-center w-full rounded-lg bg-amber-500/10 text-[11px] font-medium text-amber-300 border border-amber-500/40">
          <span class="w-1.5 h-1.5 rounded-full bg-amber-400 mr-1.5"></span>
          Prototype
        </span>
      </div>
    </aside>
    <div class="flex-1 flex flex-col">

  <!-- hidden utility swatches for Tailwind -->
  <div class="hidden">
    <span class="bg-emerald-50 text-emerald-700 border-emerald-100"></span>
    <span class="bg-amber-50 text-amber-700 border-amber-100"></span>
    <span class="bg-rose-50 text-rose-700 border-rose-100"></span>
    <span class="bg-slate-100 text-slate-700 border-slate-200"></span>
    <span class="bg-violet-50 text-violet-700 border-violet-100"></span>
  </div>

  <div class="max-w-6xl mx-auto px-4 py-8 md:py-10 space-y-8">


  <!-- HOME PAGE PANEL -->
  <section data-page-panel="home" class="space-y-10">
    <!-- Hero -->
    <div class="bg-slate-950 text-slate-50 rounded-3xl border border-slate-800/60 shadow-md overflow-hidden relative">
      <div class="absolute inset-0 pointer-events-none opacity-60"
           style="background: radial-gradient(circle at top left, rgba(56,189,248,0.16), transparent 55%), radial-gradient(circle at bottom right, rgba(129,140,248,0.2), transparent 55%);">
      </div>
      <div class="relative px-6 sm:px-8 md:px-10 py-8 md:py-10 flex flex-col md:flex-row md:items-center gap-8">
        <div class="md:w-3/5 space-y-4">
          <div class="inline-flex items-center gap-2 rounded-full border border-sky-400/40 bg-slate-900/70 px-3 py-1 text-xs font-medium text-sky-100">
            <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse"></span>
            Live prototype • SJU data helper
          </div>
          <h1 class="text-2xl sm:text-3xl md:text-4xl font-semibold tracking-tight text-slate-50">
            Build a schedule you’ll actually love with <span class="text-sky-300">EasyClasses</span>.
          </h1>
          <p class="text-sm sm:text-base text-slate-200/80 max-w-xl">
            Find classes, compare professors, see waitlist chances, and plan a schedule that fits your life — all in one place.
          </p>

          <div class="flex flex-wrap gap-3 pt-2">
            <a href="?page=schedule-builder"
               data-nav="schedule-builder"
               class="inline-flex items-center gap-2 rounded-full bg-sky-500 hover:bg-sky-400 text-white text-sm font-medium px-4 py-2.5 shadow-sm shadow-sky-500/40 transition">
              <i class="fa-solid fa-magic-wand-sparkles text-xs"></i>
              Build a new schedule
            </a>
            <a href="?page=schedule-optimizer"
               data-nav="schedule-optimizer"
               class="inline-flex items-center gap-2 rounded-full bg-slate-800/80 hover:bg-slate-700 text-slate-50 text-sm font-medium px-4 py-2.5 border border-slate-700/80 transition">
              <i class="fa-solid fa-wand-magic-sparkles text-xs"></i>
              Optimize my current one
            </a>
            <a href="?page=course-search"
               data-nav="course-search"
               class="inline-flex items-center gap-2 rounded-full bg-slate-900/80 hover:bg-slate-800 text-slate-100 text-xs sm:text-sm font-medium px-3.5 py-2 border border-slate-700/80 transition">
              <i class="fa-solid fa-magnifying-glass text-xs"></i>
              Browse all courses
            </a>
          </div>

          <div class="pt-3 text-[11px] sm:text-xs text-slate-300/80 leading-snug">
            EasyClasses is an independent student project for personal planning.
            It is <span class="font-semibold text-slate-50">not affiliated with, endorsed by, or officially connected</span>
            to St. John&apos;s University. Always double-check against official SJU systems.
          </div>
        </div>

        <div class="md:w-2/5">
          <div class="bg-slate-900/80 border border-slate-700/80 rounded-2xl px-4 py-4 sm:px-5 sm:py-5 space-y-4 shadow-inner">
            <p class="text-xs font-medium text-slate-300 uppercase tracking-wide">
              Live data snapshot
            </p>
            <div class="grid grid-cols-2 gap-3 text-xs">
              <div class="space-y-1">
                <p class="text-slate-400">Sections loaded</p>
                <p id="liveTotalSections" class="text-lg font-semibold text-sky-300">–</p>
              </div>
              <div class="space-y-1">
                <p class="text-slate-400">Professors indexed</p>
                <p id="liveTotalProfs" class="text-lg font-semibold text-emerald-300">–</p>
              </div>
              <div class="space-y-1">
                <p class="text-slate-400">Sections with WL odds</p>
                <p id="liveWlSections" class="text-lg font-semibold text-violet-300">–</p>
              </div>
              <div class="space-y-1">
                <p class="text-slate-400">Last refreshed</p>
                <p id="liveUpdatedAt" class="text-[11px] text-slate-200/90 leading-snug">
                  When data finishes loading
                </p>
              </div>
            </div>
            <p class="text-[11px] text-slate-400 leading-snug">
              Data pulled from SJU course exports + professor rating sources. Estimates only — no guarantees.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Tools grid -->
    <div class="grid gap-4 md:gap-6 md:grid-cols-2 lg:grid-cols-3">
      <div class="bg-white/90 border border-slate-100 rounded-2xl p-4 sm:p-5 shadow-sm flex flex-col gap-2">
        <div class="inline-flex items-center justify-between gap-2">
          <h2 class="text-sm font-semibold text-slate-900 flex items-center gap-2">
            <span class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-sky-100 text-sky-600">
              <i class="fa-solid fa-magnifying-glass text-xs"></i>
            </span>
            Course Search
          </h2>
          <a href="?page=course-search"
             data-nav="course-search"
             class="text-xs font-medium text-sky-600 hover:text-sky-700">
            Open
          </a>
        </div>
        <p class="text-xs text-slate-600">
          Filter by subject, campus, difficulty, delivery mode, and waitlist odds. View seat breakdown and meeting details for every section.
        </p>
      </div>

      <div class="bg-white/90 border border-slate-100 rounded-2xl p-4 sm:p-5 shadow-sm flex flex-col gap-2">
        <div class="inline-flex items-center justify-between gap-2">
          <h2 class="text-sm font-semibold text-slate-900 flex items-center gap-2">
            <span class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-emerald-100 text-emerald-600">
              <i class="fa-solid fa-file-lines text-xs"></i>
            </span>
            Advisement PDF Parser
          </h2>
          <a href="?page=schedule-builder"
             data-nav="schedule-builder"
             class="text-xs font-medium text-sky-600 hover:text-sky-700">
            Open
          </a>
        </div>
        <p class="text-xs text-slate-600">
          Upload your advisement sheet and extract the course numbers you still need. No manual typing required.
        </p>
      </div>

      <div class="bg-white/90 border border-slate-100 rounded-2xl p-4 sm:p-5 shadow-sm flex flex-col gap-2">
        <div class="inline-flex items-center justify-between gap-2">
          <h2 class="text-sm font-semibold text-slate-900 flex items-center gap-2">
            <span class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-indigo-100 text-indigo-600">
              <i class="fa-solid fa-calendar-days text-xs"></i>
            </span>
            Time Preference Builder
          </h2>
          <a href="?page=schedule-builder"
             data-nav="schedule-builder"
             class="text-xs font-medium text-sky-600 hover:text-sky-700">
            Open
          </a>
        </div>
        <p class="text-xs text-slate-600">
          Choose which days and time windows you want classes. We convert it into a machine-readable grid for schedule generation.
        </p>
      </div>

      <div class="bg-white/90 border border-slate-100 rounded-2xl p-4 sm:p-5 shadow-sm flex flex-col gap-2">
        <div class="inline-flex items-center justify-between gap-2">
          <h2 class="text-sm font-semibold text-slate-900 flex items-center gap-2">
            <span class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-violet-100 text-violet-600">
              <i class="fa-solid fa-wand-magic-sparkles text-xs"></i>
            </span>
            Schedule Optimizer
          </h2>
          <a href="?page=schedule-optimizer"
             data-nav="schedule-optimizer"
             class="text-xs font-medium text-sky-600 hover:text-sky-700">
            Open
          </a>
        </div>
        <p class="text-xs text-slate-600">
          Paste or upload a screenshot of your current schedule. We extract CRNs, compare difficulty, and suggest easier or safer alternatives.
        </p>
      </div>

      <div class="bg-white/90 border border-slate-100 rounded-2xl p-4 sm:p-5 shadow-sm flex flex-col gap-2">
        <div class="inline-flex items-center justify-between gap-2">
          <h2 class="text-sm font-semibold text-slate-900 flex items-center gap-2">
            <span class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-amber-100 text-amber-600">
              <i class="fa-solid fa-face-smile-beam text-xs"></i>
            </span>
            Professor Difficulty Engine
          </h2>
          <span class="text-[11px] font-medium text-amber-700 bg-amber-50 rounded-full px-2 py-0.5 border border-amber-100">
            Uses RMP-style stats
          </span>
        </div>
        <p class="text-xs text-slate-600">
          Difficulty labels, would-take-again percentages, and rating counts are baked directly into every section card.
        </p>
      </div>

      <div class="bg-white/90 border border-slate-100 rounded-2xl p-4 sm:p-5 shadow-sm flex flex-col gap-2">
        <div class="inline-flex items-center justify-between gap-2">
          <h2 class="text-sm font-semibold text-slate-900 flex items-center gap-2">
            <span class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-rose-100 text-rose-600">
              <i class="fa-solid fa-chart-line text-xs"></i>
            </span>
            Waitlist Probability Model
          </h2>
          <span class="text-[11px] font-medium text-rose-700 bg-rose-50 rounded-full px-2 py-0.5 border border-rose-100">
            Experimental
          </span>
        </div>
        <p class="text-xs text-slate-600">
          We estimate how likely additional seats are to open before add/drop using a simple Poisson-style model. Helpful signal, not a promise.
        </p>
      </div>
    </div>

    <!-- How it works -->
    <div class="bg-white/90 border border-slate-100 rounded-3xl p-5 sm:p-6 lg:p-7 shadow-sm space-y-4">
      <p class="text-xs font-semibold text-sky-700 uppercase tracking-wide">
        How EasyClasses fits into your semester
      </p>
      <div class="grid gap-4 md:grid-cols-3 text-xs">
        <div class="space-y-1.5">
          <p class="text-[11px] font-semibold text-slate-800 flex items-center gap-1.5 uppercase tracking-wide">
            <span class="inline-flex items-center justify-center w-4 h-4 rounded-full bg-slate-900 text-slate-50 text-[10px]">1</span>
            Import what you&apos;re working with
          </p>
          <p class="text-slate-600">
            Add your advisement sheet, a screenshot of your schedule, or simply start browsing classes.
          </p>
        </div>
        <div class="space-y-1.5">
          <p class="text-[11px] font-semibold text-slate-800 flex items-center gap-1.5 uppercase tracking-wide">
            <span class="inline-flex items-center justify-center w-4 h-4 rounded-full bg-slate-900 text-slate-50 text-[10px]">2</span>
            Tell us your constraints
          </p>
          <p class="text-slate-600">
            Choose the days, times, campuses, and difficulty levels you prefer. We’ll show it as a simple week view that’s easy to understand.
          </p>
        </div>
        <div class="space-y-1.5">
          <p class="text-[11px] font-semibold text-slate-800 flex items-center gap-1.5 uppercase tracking-wide">
            <span class="inline-flex items-center justify-center w-4 h-4 rounded-full bg-slate-900 text-slate-50 text-[10px]">3</span>
            Explore smarter schedules
          </p>
          <p class="text-slate-600">
            Use Course Search, the Builder, and the Optimizer together to find schedules that are realistic <em>and</em> low-stress.
          </p>
        </div>
      </div>

      <div class="pt-1 text-[11px] text-slate-500">
        This tool is for personal exploration and planning. Final decisions should rely on official university sources like UIS/Banner and your academic advisor.
      </div>
    </div>
  </section>

  <!-- COURSE SEARCH PAGE PANEL -->

  <section data-page-panel="course-search" class="space-y-4">
    <!-- PAGE HEADER -->
    <header class="mb-6">
      <h1 class="text-2xl md:text-3xl font-semibold tracking-tight text-slate-900">
        EasyClasses SJU • Spring 2026
      </h1>
      <p class="text-sm md:text-[0.9rem] text-slate-500 mt-1">
        Search by subject, campus, or instructor and see difficulty, workload, seats, and waitlist chances in one clean view.
      </p>
    </header>

    <!-- SEARCH + FILTERS -->
    <section class="bg-white/90 backdrop-blur rounded-3xl shadow-sm border border-slate-100 p-4 md:p-5 mb-5">
      <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4 md:gap-6">
        <div class="flex-1 space-y-3">
          <label class="text-xs font-medium text-slate-500 block">Search</label>
          <div class="relative">
            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">
              <i class="fa-solid fa-magnifying-glass"></i>
            </span>
            <input
              id="searchInput"
              type="text"
              placeholder="Search by course, CRN, or professor…"
              class="w-full rounded-2xl border border-slate-200 bg-slate-50/80 py-2.5 pl-10 pr-3 text-sm focus:border-brand-500 focus:ring-2 focus:ring-brand-100 outline-none transition"
            />
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div>
              <label class="text-xs font-medium text-slate-500 block mb-1">Subject</label>
              <select
                id="subjectFilter"
                class="w-full rounded-2xl border border-slate-200 bg-slate-50/80 py-2.5 px-3 text-sm focus:border-brand-500 focus:ring-2 focus:ring-brand-100 outline-none transition"
              >
                <option value="">All subjects</option>
              </select>
            </div>
            <div>
              <label class="text-xs font-medium text-slate-500 block mb-1">Campus</label>
              <select
                id="campusFilter"
                class="w-full rounded-2xl border border-slate-200 bg-slate-50/80 py-2.5 px-3 text-sm focus:border-brand-500 focus:ring-2 focus:ring-brand-100 outline-none transition"
              >
                <option value="">All campuses</option>
              </select>
            </div>
          </div>
        </div>

        <!-- right filters -->
        <div class="md:w-72 space-y-3">
          <div>
            <div class="flex items-center justify-between mb-1">
              <span class="text-xs font-medium text-slate-500">Difficulty</span>
              <button id="clearDifficulty" class="text-[0.7rem] text-slate-400 hover:text-brand-600">
                Reset
              </button>
            </div>
            <div class="flex flex-wrap gap-1.5">
              <button data-diff="" class="difficulty-chip px-3 py-1.5 rounded-full text-xs border border-slate-200 bg-slate-50 text-slate-700">
                Any
              </button>
              <button data-diff="Easy" class="difficulty-chip px-3 py-1.5 rounded-full text-xs border border-slate-200 bg-emerald-50 text-emerald-700">
                Easy
              </button>
              <button data-diff="Moderate" class="difficulty-chip px-3 py-1.5 rounded-full text-xs border border-slate-200 bg-amber-50 text-amber-700">
                Moderate
              </button>
              <button data-diff="Challenging" class="difficulty-chip px-3 py-1.5 rounded-full text-xs border border-slate-200 bg-violet-50 text-violet-700">
                Challenging
              </button>
              <button data-diff="Demanding" class="difficulty-chip px-3 py-1.5 rounded-full text-xs border border-slate-200 bg-rose-50 text-rose-700">
                Demanding
              </button>
            </div>
          </div>

          <div class="flex items-center justify-between rounded-2xl border border-slate-100 bg-slate-50/70 px-3 py-2.5">
            <div>
              <p class="text-xs font-medium text-slate-700">Good waitlist odds only</p>
              <p class="text-[0.7rem] text-slate-400">Hide sections with low WL chance.</p>
            </div>
            <button
              id="wlToggle"
              class="relative inline-flex h-6 w-11 items-center rounded-full border border-slate-200 bg-white transition"
            >
              <span class="sr-only">Toggle good waitlist odds</span>
              <span class="dot inline-block h-4 w-4 rounded-full bg-slate-300 transform transition translate-x-1"></span>
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- STATUS -->
    <div class="flex items-center justify-between text-xs text-slate-500 mb-2">
      <span id="statusText">Loading sections…</span>
      <span class="hidden sm:inline text-[0.7rem]">Data source: Sheet2API (subjects & professor ratings).</span>
    </div>

    <!-- RESULTS -->
    <section id="resultsContainer" class="space-y-3 mb-10"></section>
  </section>

  <!-- SCHEDULE BUILDER PAGE PANEL -->
  <section data-page-panel="schedule-builder" class="space-y-5 hidden">

    <header class="mb-3">
      <h1 class="text-2xl md:text-3xl font-semibold tracking-tight text-slate-900">
        Schedule Builder
      </h1>
      <p class="text-sm md:text-[0.9rem] text-slate-500 mt-1">
        Upload your advisement sheet (PDF). We’ll read your course list for you — no manual typing.
      </p>
    </header>

    <div class="grid gap-5 md:grid-cols-[minmax(0,2fr)_minmax(0,3fr)]">
      <!-- Left: upload + controls -->
      <div class="bg-white/90 backdrop-blur rounded-3xl shadow-sm border border-slate-100 p-4 md:p-5 space-y-4">
        <h2 class="text-sm font-semibold text-slate-800 flex items-center gap-2">
          <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-sky-50 text-sky-600 text-xs">
            <i class="fa-solid fa-file-pdf"></i>
          </span>
          Advisement sheet upload
        </h2>
        <p class="text-xs text-slate-500">
          Use the official advisement form that lists your <span class="font-medium">Part 2: Desired Course Selection</span>.
          We’ll only process the file in your browser.
        </p>

        <div class="border border-dashed border-slate-200 rounded-2xl bg-slate-50/70 px-4 py-5 space-y-3">
          <label
            for="builderPdfInput"
            class="inline-flex items-center gap-2 rounded-full bg-slate-900 text-slate-50 px-4 py-2 text-xs font-medium shadow-sm cursor-pointer hover:bg-slate-800 transition"
          >
            <i class="fa-solid fa-upload text-[0.8rem]"></i>
            <span>Choose PDF</span>
          </label>
          <input
            id="builderPdfInput"
            type="file"
            accept="application/pdf"
            class="sr-only"
          />

          <p id="builderFileName" class="text-[0.72rem] text-slate-500">
            No file selected yet.
          </p>

          <button
            id="builderRunBtn"
            type="button"
            disabled
            class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-4 py-2 text-xs font-medium text-slate-700 hover:border-sky-400 hover:text-sky-700 disabled:opacity-50 disabled:cursor-not-allowed transition"
          >
            <i class="fa-solid fa-wand-magic-sparkles text-[0.8rem]"></i>
            <span>Find my classes</span>
          </button>

          <p class="text-[0.7rem] text-slate-400">
            Tip: If nothing shows up, make sure your PDF actually contains a
            “Part 2: Desired Course Selection” section.
          </p>
        </div>
      </div>

      <!-- Right: extracted courses -->
      <div class="bg-white/90 backdrop-blur rounded-3xl shadow-sm border border-slate-100 p-4 md:p-5 flex flex-col">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-sm font-semibold text-slate-800 flex items-center gap-2">
            <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-emerald-50 text-emerald-600 text-xs">
              <i class="fa-solid fa-list-check"></i>
            </span>
            Detected courses
          </h2>
          <span
            id="builderCountBadge"
            class="hidden rounded-full bg-slate-100 text-slate-700 border border-slate-200 text-[0.7rem] px-2 py-0.5"
          ></span>
        </div>

        <ul
          id="builderCourseList"
          class="flex-1 space-y-1.5 text-sm text-slate-800 overflow-auto"
        >
          <li class="text-xs text-slate-400">
            Upload a PDF and click <span class="font-semibold">“Extract courses”</span> to see your list here.
          </li>
        </ul>

        <details class="mt-4 text-xs text-slate-500">
          <summary class="cursor-pointer text-[0.7rem] text-slate-400">
            Show raw “Part 2” text (debug)
          </summary>
          <pre
            id="builderSectionDebug"
            class="mt-2 max-h-48 overflow-auto rounded-2xl bg-slate-950/90 text-[0.7rem] text-slate-100 p-3 whitespace-pre-wrap"
          ></pre>
        </details>
      </div>
    </div>
  </section>

  <!-- TIME PREFERENCES PANEL -->
  <section data-page-panel="schedule-builder" class="space-y-4">
    <div class="bg-white/90 backdrop-blur rounded-3xl shadow-sm border border-slate-100 p-4 md:p-5">
      <div class="grid gap-6 lg:grid-cols-[minmax(0,2fr)_minmax(0,2.2fr)]">
        <!-- Left: controls -->
        <div class="space-y-4">
          <div>
            <h2 class="text-sm font-semibold text-slate-800 flex items-center gap-2">
              <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-sky-50 text-sky-600 text-xs">
                <i class="fa-solid fa-clock"></i>
              </span>
              When do you want classes?
            </h2>
            <p class="text-xs text-slate-500 mt-1">
              Choose the days and time window you’d like to have class. You can override specific days if they follow a different schedule.
            </p>
          </div>

          <!-- Days of week -->
          <div class="space-y-2">
            <span class="text-[0.7rem] font-medium text-slate-500 uppercase tracking-wide">Days of the week</span>
            <div class="flex flex-wrap gap-1.5">
              <button type="button" class="time-day-pill px-3 py-1.5 rounded-full text-xs border border-slate-200 bg-slate-50 text-slate-700" data-day-key="Mon">M</button>
              <button type="button" class="time-day-pill px-3 py-1.5 rounded-full text-xs border border-slate-200 bg-slate-50 text-slate-700" data-day-key="Tue">Tu</button>
              <button type="button" class="time-day-pill px-3 py-1.5 rounded-full text-xs border border-slate-200 bg-slate-50 text-slate-700" data-day-key="Wed">W</button>
              <button type="button" class="time-day-pill px-3 py-1.5 rounded-full text-xs border border-slate-200 bg-slate-50 text-slate-700" data-day-key="Thu">Th</button>
              <button type="button" class="time-day-pill px-3 py-1.5 rounded-full text-xs border border-slate-200 bg-slate-50 text-slate-700" data-day-key="Fri">F</button>
            </div>
          </div>

          <!-- Default window -->
          <div class="space-y-2">
            <div class="flex items-center justify-between">
              <span class="text-[0.7rem] font-medium text-slate-500 uppercase tracking-wide">Default time window</span>
              <span class="text-[0.7rem] text-slate-400">Applied to all selected days</span>
            </div>
            <div class="flex items-center gap-2 text-xs">
              <label class="flex items-center gap-1.5">
                <span class="text-slate-500">From</span>
                <select id="timeDefaultFrom" class="rounded-xl border border-slate-200 bg-slate-50 px-2 py-1.5 text-xs focus:border-brand-500 focus:ring-1 focus:ring-brand-100 outline-none">
                </select>
              </label>
              <label class="flex items-center gap-1.5">
                <span class="text-slate-500">To</span>
                <select id="timeDefaultTo" class="rounded-xl border border-slate-200 bg-slate-50 px-2 py-1.5 text-xs focus:border-brand-500 focus:ring-1 focus:ring-brand-100 outline-none">
                </select>
              </label>
            </div>
          </div>

          <!-- Custom per-day -->
          <div class="space-y-2">
            <span class="text-[0.7rem] font-medium text-slate-500 uppercase tracking-wide">Custom windows per day (optional)</span>
            <div class="space-y-2.5 text-xs">
              
              <div class="flex items-center justify-between gap-2" data-time-row="Mon">
                <div class="flex items-center gap-2">
                  <label class="inline-flex items-center gap-1.5">
                    <input type="checkbox" class="time-custom-toggle h-3.5 w-3.5 rounded border-slate-300 text-brand-500" data-time-custom-toggle="Mon">
                    <span class="text-slate-700">Monday</span>
                  </label>
                  <span class="text-[0.68rem] text-slate-400 hidden sm:inline">Use custom window for this day</span>
                </div>
                <div class="flex items-center gap-2">
                  <select data-time-custom-from="Mon" class="rounded-xl border border-slate-200 bg-slate-50 px-2 py-1.5 text-[0.7rem] focus:border-brand-500 focus:ring-1 focus:ring-brand-100 outline-none" disabled></select>
                  <span class="text-[0.7rem] text-slate-400">to</span>
                  <select data-time-custom-to="Mon" class="rounded-xl border border-slate-200 bg-slate-50 px-2 py-1.5 text-[0.7rem] focus:border-brand-500 focus:ring-1 focus:ring-brand-100 outline-none" disabled></select>
                </div>
              </div>

              <div class="flex items-center justify-between gap-2" data-time-row="Tue">
                <div class="flex items-center gap-2">
                  <label class="inline-flex items-center gap-1.5">
                    <input type="checkbox" class="time-custom-toggle h-3.5 w-3.5 rounded border-slate-300 text-brand-500" data-time-custom-toggle="Tue">
                    <span class="text-slate-700">Tuesday</span>
                  </label>
                  <span class="text-[0.68rem] text-slate-400 hidden sm:inline">Use custom window for this day</span>
                </div>
                <div class="flex items-center gap-2">
                  <select data-time-custom-from="Tue" class="rounded-xl border border-slate-200 bg-slate-50 px-2 py-1.5 text-[0.7rem] focus:border-brand-500 focus:ring-1 focus:ring-brand-100 outline-none" disabled></select>
                  <span class="text-[0.7rem] text-slate-400">to</span>
                  <select data-time-custom-to="Tue" class="rounded-xl border border-slate-200 bg-slate-50 px-2 py-1.5 text-[0.7rem] focus:border-brand-500 focus:ring-1 focus:ring-brand-100 outline-none" disabled></select>
                </div>
              </div>

              <div class="flex items-center justify-between gap-2" data-time-row="Wed">
                <div class="flex items-center gap-2">
                  <label class="inline-flex items-center gap-1.5">
                    <input type="checkbox" class="time-custom-toggle h-3.5 w-3.5 rounded border-slate-300 text-brand-500" data-time-custom-toggle="Wed">
                    <span class="text-slate-700">Wednesday</span>
                  </label>
                  <span class="text-[0.68rem] text-slate-400 hidden sm:inline">Use custom window for this day</span>
                </div>
                <div class="flex items-center gap-2">
                  <select data-time-custom-from="Wed" class="rounded-xl border border-slate-200 bg-slate-50 px-2 py-1.5 text-[0.7rem] focus:border-brand-500 focus:ring-1 focus:ring-brand-100 outline-none" disabled></select>
                  <span class="text-[0.7rem] text-slate-400">to</span>
                  <select data-time-custom-to="Wed" class="rounded-xl border border-slate-200 bg-slate-50 px-2 py-1.5 text-[0.7rem] focus:border-brand-500 focus:ring-1 focus:ring-brand-100 outline-none" disabled></select>
                </div>
              </div>

              <div class="flex items-center justify-between gap-2" data-time-row="Thu">
                <div class="flex items-center gap-2">
                  <label class="inline-flex items-center gap-1.5">
                    <input type="checkbox" class="time-custom-toggle h-3.5 w-3.5 rounded border-slate-300 text-brand-500" data-time-custom-toggle="Thu">
                    <span class="text-slate-700">Thursday</span>
                  </label>
                  <span class="text-[0.68rem] text-slate-400 hidden sm:inline">Use custom window for this day</span>
                </div>
                <div class="flex items-center gap-2">
                  <select data-time-custom-from="Thu" class="rounded-xl border border-slate-200 bg-slate-50 px-2 py-1.5 text-[0.7rem] focus:border-brand-500 focus:ring-1 focus:ring-brand-100 outline-none" disabled></select>
                  <span class="text-[0.7rem] text-slate-400">to</span>
                  <select data-time-custom-to="Thu" class="rounded-xl border border-slate-200 bg-slate-50 px-2 py-1.5 text-[0.7rem] focus:border-brand-500 focus:ring-1 focus:ring-brand-100 outline-none" disabled></select>
                </div>
              </div>

              <div class="flex items-center justify-between gap-2" data-time-row="Fri">
                <div class="flex items-center gap-2">
                  <label class="inline-flex items-center gap-1.5">
                    <input type="checkbox" class="time-custom-toggle h-3.5 w-3.5 rounded border-slate-300 text-brand-500" data-time-custom-toggle="Fri">
                    <span class="text-slate-700">Friday</span>
                  </label>
                  <span class="text-[0.68rem] text-slate-400 hidden sm:inline">Use custom window for this day</span>
                </div>
                <div class="flex items-center gap-2">
                  <select data-time-custom-from="Fri" class="rounded-xl border border-slate-200 bg-slate-50 px-2 py-1.5 text-[0.7rem] focus:border-brand-500 focus:ring-1 focus:ring-brand-100 outline-none" disabled></select>
                  <span class="text-[0.7rem] text-slate-400">to</span>
                  <select data-time-custom-to="Fri" class="rounded-xl border border-slate-200 bg-slate-50 px-2 py-1.5 text-[0.7rem] focus:border-brand-500 focus:ring-1 focus:ring-brand-100 outline-none" disabled></select>
                </div>
              </div>
            </div>
          </div>

          <p id="timeSummaryText" class="text-[0.7rem] text-slate-500 mt-2">
            Select at least one day and a time range.
          </p>
        </div>

        <!-- Right: weekly grid -->
        <div>
          <div class="flex items-center justify-between mb-2">
            <span class="text-xs font-semibold text-slate-700">Weekly view</span>
            <span class="inline-flex items-center gap-1 rounded-full bg-sky-50 text-sky-700 border border-sky-100 px-2 py-0.5 text-[0.7rem]">
              <span class="inline-block h-2 w-2 rounded-sm bg-sky-500"></span>
              <span>Preferred class times</span>
            </span>
          </div>
          <div class="rounded-3xl border border-slate-100 bg-slate-50/80 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="min-w-full border-collapse text-[0.7rem] text-slate-500">
                <thead class="bg-slate-100/70">
                  <tr>
                    <th class="px-2 py-2 text-left font-medium border-b border-slate-100 w-16">Time</th>
                    <th class="px-2 py-2 text-center font-medium border-b border-slate-100">Mon</th>
                    <th class="px-2 py-2 text-center font-medium border-b border-slate-100">Tue</th>
                    <th class="px-2 py-2 text-center font-medium border-b border-slate-100">Wed</th>
                    <th class="px-2 py-2 text-center font-medium border-b border-slate-100">Thu</th>
                    <th class="px-2 py-2 text-center font-medium border-b border-slate-100">Fri</th>
                  </tr>
                </thead>
                <tbody id="timeGridBody">
                  <!-- Rows injected by JS -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Schedule options panel -->
    <div class="mt-4 bg-slate-900/95 text-slate-50 rounded-3xl shadow-sm border border-slate-800/70 p-4 md:p-5 space-y-3">
      <div class="flex items-center justify-between gap-2">
        <div>
          <h2 class="text-sm font-semibold flex items-center gap-2">
            <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-emerald-500/20 text-emerald-300 text-xs">
              <i class="fa-solid fa-calendar-check"></i>
            </span>
            Schedule options
          </h2>
          <p class="text-[0.72rem] text-slate-300 mt-1">
            Once you’ve extracted your required courses and chosen your time windows, generate schedule options that balance easier professors, availability, and your preferences.
          </p>
        </div>
        <button
          id="generateScheduleBtn"
          type="button"
          class="inline-flex items-center gap-2 rounded-full bg-emerald-400/90 text-slate-950 text-xs font-semibold px-4 py-2 shadow-sm hover:bg-emerald-300 disabled:opacity-60 disabled:cursor-not-allowed transition"
        >
          <i class="fa-solid fa-wand-magic-sparkles text-[0.8rem]"></i>
          <span>Generate schedules</span>
        </button>
      </div>
      <p id="scheduleHelperText" class="text-[0.7rem] text-emerald-200/90">
        Tip: Start by uploading your advisement PDF above. We’ll use the detected course numbers plus your time preferences here.
      </p>
      <div
        id="scheduleOptionsContainer"
        class="mt-2 space-y-2 text-[0.72rem]"
      >
        <div class="text-slate-300/90">
          No schedules generated yet.
        </div>
      </div>
    </div>

  </section>
  <!-- SCHEDULE OPTIMIZER PAGE PANEL -->
  <section data-page-panel="schedule-optimizer" class="space-y-5 hidden">

    <header class="mb-3">
      <h1 class="text-2xl md:text-3xl font-semibold tracking-tight text-slate-900">
        Schedule Optimizer
      </h1>
      <p class="text-sm md:text-[0.9rem] text-slate-500 mt-1">
        Upload, paste, or drag-and-drop an image of your current schedule. We’ll read it and suggest easier swaps.
      </p>
    </header>

    <div class="grid gap-5 md:grid-cols-[minmax(0,2fr)_minmax(0,3fr)]">
      <!-- Left: upload / paste -->
      <div class="bg-white/90 backdrop-blur rounded-3xl shadow-sm border border-slate-100 p-4 md:p-5 space-y-4">
        <h2 class="text-sm font-semibold text-slate-800 flex items-center gap-2">
          <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-emerald-50 text-emerald-600 text-xs">
            <i class="fa-regular fa-image"></i>
          </span>
          Add your schedule image
        </h2>

        <!-- Dropzone -->
        <label
          id="optimizerDropzone"
          class="relative group cursor-pointer rounded-2xl border-2 border-dashed border-slate-200 hover:border-sky-300 bg-slate-50/60 p-6 md:p-8 flex flex-col items-center justify-center text-center transition"
        >
          <input
            id="optimizerFileInput"
            type="file"
            accept="image/*"
            class="absolute inset-0 opacity-0 cursor-pointer"
          />
          <div class="flex flex-col items-center gap-2">
            <div class="h-12 w-12 rounded-full bg-white shadow-sm border border-slate-100 flex items-center justify-center text-slate-600 group-hover:text-sky-600 transition">
              <i class="fa-solid fa-cloud-arrow-up text-lg"></i>
            </div>
            <p class="font-medium text-slate-800">
              Drag &amp; drop your schedule here
            </p>
            <p class="text-xs text-slate-500">
              or click to upload • PNG, JPG, HEIC, etc.
            </p>
          </div>
        </label>

        <!-- Paste shortcut -->
        <div class="flex flex-col sm:flex-row sm:items-center gap-2">
          <button
            id="optimizerPasteBtn"
            type="button"
            class="inline-flex items-center justify-center gap-2 rounded-full bg-slate-900 text-white px-4 py-2 text-sm font-medium hover:bg-slate-800 transition"
          >
            <i class="fa-regular fa-clipboard"></i>
            Paste from clipboard
          </button>
          <p class="text-xs text-slate-500">
            Tip: you can also press <span class="font-semibold">Ctrl/Cmd + V</span> anywhere on this page.
          </p>
        </div>

        <!-- Optional notes (future use) -->
        <textarea
          id="optimizerNotes"
          rows="4"
          placeholder="Optional: add notes about your schedule (e.g., days you can’t attend, preferred times)."
          class="w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-800 placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-200"
        ></textarea>

        <p class="text-[0.7rem] text-slate-400">
          We only use your image to read class times and suggest easier alternatives. Nothing is stored.
        </p>
      </div>

      <!-- Right: preview -->
      <div class="bg-white/90 backdrop-blur rounded-3xl shadow-sm border border-slate-100 p-4 md:p-5 space-y-3">
        <h2 class="text-sm font-semibold text-slate-800 flex items-center gap-2">
          <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-sky-50 text-sky-600 text-xs">
            <i class="fa-solid fa-eye"></i>
          </span>
          Preview
        </h2>

        <div
          id="optimizerPreview"
          class="w-full aspect-[4/3] rounded-2xl border border-slate-100 bg-slate-50 flex items-center justify-center text-slate-400 text-sm"
        >
          No image yet.
        </div>
<div class="flex items-start gap-2 text-xs text-slate-500">
          <i class="fa-solid fa-wand-magic-sparkles mt-0.5 text-slate-400"></i>
          <p>
            Once uploaded, we’ll detect your classes and meeting patterns, score difficulty, and recommend easier swaps.
          </p>
        </div>
      </div>

<!-- Detected CRNs + Lock button -->
<div class="bg-white/90 backdrop-blur rounded-3xl shadow-sm border border-slate-100 p-4 md:p-5 space-y-3">
  <div class="flex items-center justify-between">
    <h2 class="text-sm font-semibold text-slate-800 flex items-center gap-2">
      <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-emerald-50 text-emerald-600 text-xs">
        <i class="fa-solid fa-hashtag"></i>
      </span>
      Detected CRNs
    </h2>

    <button id="lockCrnsBtn"
      class="inline-flex items-center gap-2 rounded-full bg-slate-900 text-white text-xs font-semibold px-4 py-2 shadow-sm hover:bg-slate-800 disabled:opacity-60 disabled:cursor-not-allowed transition"
      disabled>
      <i class="fa-solid fa-lock text-[0.8rem]"></i>
      Lock & Analyze
    </button>
  </div>

  <div id="optimizerCrnResults" class="text-[0.8rem] text-slate-700">
    No CRNs detected yet.
  </div>

  <div id="optimizerRecommendations" class="text-[0.8rem] text-slate-700 space-y-2"></div>
</div>

    </div>

  </section>

  
<!-- AI CHAT PAGE PANEL -->
  <section data-page-panel="ai-chat" class="hidden min-h-[calc(100vh-4.5rem)] lg:h-[calc(100vh-4.5rem)] flex flex-col bg-slate-50 md:bg-gradient-to-b md:from-slate-50 md:to-slate-100 dark:bg-slate-950 -mx-4 md:mx-0 overflow-hidden">
    <div class="flex-1 flex flex-col h-full">
      <!-- Scrollable header + chat -->
      <div class="flex-1 min-h-0 overflow-y-auto ai-chat-scroll">
        <div class="px-4 md:px-0">
          <div class="mx-auto w-full max-w-3xl px-2 md:px-4 pb-44 space-y-6">
            <header class="pt-10 pb-6 text-center px-4 md:px-0">
                    <div class="mx-auto mb-3 h-10 w-10 rounded-2xl bg-sky-500/10 flex items-center justify-center">
                      <i class="fa-solid fa-sparkles text-sky-500"></i>
                    </div>
                    <h1 class="text-2xl md:text-3xl font-semibold tracking-tight text-slate-900 dark:text-slate-100">
                      AI Schedule Assistant
                    </h1>
                    <p class="mt-1 text-sm md:text-[0.95rem] text-slate-600 dark:text-slate-300 ai-chat-subtitle">
                      Effortless help building or optimizing your schedule.
                    </p>
                  </header>
            <div id="aiChatMessages" class="space-y-4">
              <!-- Messages injected by JS -->
            </div>
          </div>
        </div>
      </div>

      <!-- Sticky composer -->
      <div class="sticky bottom-0 left-0 right-0 bg-transparent ai-chat-composer">
              <div class="mx-auto w-full max-w-3xl px-4 pb-4 pt-0 space-y-3">
                <div id="aiChatChips" class="flex flex-wrap gap-3">
                  <!-- Chips injected by JS -->
                </div>

                <div class="flex items-center gap-2">
                  <button id="aiChatUploadBtn" type="button"
                    class="inline-flex items-center gap-2 px-3 h-11 rounded-2xl border border-slate-200 bg-white text-slate-700 hover:border-sky-400 hover:bg-sky-50 text-sm shadow-sm">
                    <i class="fa-solid fa-paperclip"></i>
                    <span>Upload</span>
                  </button>
                  <input id="aiChatFileInput" type="file" class="hidden" />

                  <div class="flex-1 flex items-center gap-2 rounded-2xl border border-slate-200 bg-white px-4 h-11 shadow-sm">
                    <input
                      id="aiChatInput"
                      type="text"
                      class="flex-1 text-[0.9rem] bg-transparent text-slate-900 placeholder:text-slate-400 focus:outline-none"
                      placeholder="Type a message..." />
                    <button
                      id="aiChatSendBtn"
                      type="button"
                      class="inline-flex items-center justify-center px-4 h-9 rounded-full bg-sky-500 text-white text-sm font-medium hover:bg-sky-600 focus:outline-none focus:ring-2 focus:ring-sky-500/60">
                      Send
                    </button>
                  </div>
                </div>
              </div>
            </div>

    

    </div>

  </section>

</div>


  
    </div>
  </div>

<script>
    // === Shared config & state ===



const miniSecCard = (s, opts = {}) => {
  if (!s) return "";

  const isCompact = opts.compact === true;

  // Basic identifiers
  const courseLabel =
    (s.subjectAbbrev ? s.subjectAbbrev + " " : "") +
    (s.courseNumber || "");
  const title = `${courseLabel}${s.crn ? ` (${s.crn})` : ""}`;
  const courseTitle = s.courseTitle || s.title || courseLabel || "";

  // Meeting info
  const when =
    (s.meetingDays || s.days || "TBA") +
    (s.meetingTime || s.time ? " • " + (s.meetingTime || s.time) : "");

  // Professor
  const prof =
    s.instructorDisplay ||
    s.professorName ||
    s.professor ||
    s.instructor ||
    s.primaryInstructor ||
    s.faculty ||
    "TBA";

  // Location
  const campus = s.campusName || s.campus || "";
  const building = s.buildingName || s.building || "";
  const room = s.room || s.roomNumber || "";
  const locationParts = [campus, building, room].filter(Boolean);
  const locationDisplay = locationParts.join(" · ");

  // Difficulty badge
  const diffLabel =
    s.difficultyLabel || s.diffLabel || (s.difficulty && s.difficulty.label);
  const diffPercent =
    typeof s.difficultyPercent === "number"
      ? Math.round(s.difficultyPercent)
      : s.difficulty && typeof s.difficulty.percent === "number"
      ? Math.round(s.difficulty.percent)
      : null;
  const diffClasses = diffLabel ? getDifficultyBadgeClasses(diffLabel) : "";
  const diffText = diffLabel
    ? `${diffLabel}${diffPercent != null ? ` · ${diffPercent}%` : ""}`
    : null;

  // Waitlist badge
  const wlLabel =
    (s.wlChance && s.wlChance.label) || s.waitlistLabel || s.wlLabel || "";
  const wlPercent =
    s.wlChance && typeof s.wlChance.percent === "number"
      ? Math.round(s.wlChance.percent)
      : null;
  const wlClasses = wlLabel ? getWaitlistBadgeClasses(wlLabel) : "";
  const wlText = wlLabel
    ? `${wlLabel}${wlPercent != null ? ` · ${wlPercent}%` : ""}`
    : null;

  // Seats text
  let seatsText = "";
  if (s.seatsTot === 0 && s.isFull) {
    seatsText = "Seats: not open";
  } else if (s.seatsRem == null || s.seatsTot == null) {
    seatsText = "Seats: n/a";
  } else {
    const filled = s.seatsTot - s.seatsRem;
    seatsText = `Seats: ${filled}/${s.seatsTot} filled`;
  }

  // Optional label above card (e.g. "Locked", "New", index, etc.)
  const labelTag = opts.label
    ? `<div class="text-[0.7rem] font-semibold uppercase tracking-wide text-slate-500 mb-0.5">
         ${opts.label}
       </div>`
    : "";

  const outerClasses = isCompact
    ? "rounded-2xl border border-slate-200/80 bg-white/95 shadow-sm px-3 py-1.5 text-[0.78rem]"
    : "rounded-2xl border border-slate-200/80 bg-white shadow-sm px-4 py-3 text-[0.85rem]";

  const headerRowClasses = isCompact
    ? "flex items-start justify-between gap-2"
    : "flex items-center justify-between gap-2";

  const subjectPillClasses = isCompact
    ? "inline-flex items-center gap-1.5 rounded-full bg-slate-100 text-slate-700 px-2 py-0.5 text-[0.7rem] font-semibold tracking-wide uppercase"
    : "inline-flex items-center gap-1.5 rounded-full bg-slate-100 text-slate-700 px-2.5 py-0.5 text-[0.7rem] font-semibold tracking-wide uppercase";

  const diffPillClasses = isCompact
    ? "inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-[0.7rem] font-medium"
    : "inline-flex items-center gap-1.5 rounded-full px-2.5 py-0.5 text-[0.75rem] font-medium";

  const wlPillClasses = isCompact
    ? "inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-[0.7rem] font-medium"
    : "inline-flex items-center gap-1.5 rounded-full px-2.5 py-0.5 text-[0.75rem] font-medium";

  return `
    <article class="${outerClasses}">
      <div class="flex flex-col gap-2">
        ${labelTag}

        <div class="${headerRowClasses}">
          <div class="flex items-center gap-2 flex-wrap min-w-0">
            <span class="${subjectPillClasses}">
              <span>${s.subjectDesc || s.subjectAbbrev || "Course"}</span>
              ${
                s.courseNumber
                  ? `<span class="text-slate-400">·</span><span>${s.courseNumber}</span>`
                  : ""
              }
            </span>
            ${
              s.crn
                ? `<span class="text-[0.7rem] text-slate-400">CRN ${s.crn}</span>`
                : ""
            }
          </div>

          ${
            diffText || wlText
              ? `<div class="flex flex-wrap justify-end gap-1">
                  ${
                    diffText
                      ? `<span class="${diffPillClasses} ${diffClasses}">${diffText}</span>`
                      : ""
                  }
                  ${
                    wlText
                      ? `<span class="${wlPillClasses} ${wlClasses}">${wlText}</span>`
                      : ""
                  }
                </div>`
              : ""
          }
        </div>

        <div class="font-semibold text-slate-900 truncate">
          ${courseTitle || title}
        </div>

        <div class="flex flex-wrap gap-2 text-slate-500">
          ${
            when
              ? `<div class="inline-flex items-center gap-1">
                   <i class="fa-regular fa-calendar"></i>
                   <span>${when}</span>
                 </div>`
              : ""
          }
          ${
            locationDisplay
              ? `<div class="inline-flex items-center gap-1">
                   <i class="fa-solid fa-location-dot text-[0.7rem]"></i>
                   <span>${locationDisplay}</span>
                 </div>`
              : ""
          }
        </div>

        <div class="flex items-center justify-between text-slate-600">
          <div class="inline-flex items-center gap-1 min-w-0">
            <i class="fa-regular fa-user text-[0.7rem] text-slate-400"></i>
            <span class="truncate">${prof}</span>
          </div>
          <div class="text-[0.7rem] text-slate-500">
            ${seatsText}
          </div>
        </div>
      </div>
    </article>
  `;
};





    const SUBJECTS_API = "https://sheet2api.com/v1/ZPeTNTUrSFuL/all_subjects_spring_2026";
    const PROFS_API    = "https://sheet2api.com/v1/ZPeTNTUrSFuL/professor_ratings";
    const SUBJECT_ABBREV_API = "https://sheet2api.com/v1/ZPeTNTUrSFuL/subjects-abbreviations";

    const searchInput     = document.getElementById("searchInput");
    const subjectFilter   = document.getElementById("subjectFilter");
    const campusFilter    = document.getElementById("campusFilter");
    const difficultyChips = Array.from(document.querySelectorAll(".difficulty-chip"));
    const wlToggle        = document.getElementById("wlToggle");
    const statusText      = document.getElementById("statusText");
    const resultsContainer= document.getElementById("resultsContainer");
const clearDifficultyBtn = document.getElementById("clearDifficulty");

    
    // SPA-style nav + deeplinks
    
    
    function setActivePage(page) {
      // highlight nav: only toggle active styles, don't override theme colors
      document.querySelectorAll("[data-nav]").forEach(link => {
        const linkPage = link.getAttribute("data-nav");
        const isActive = linkPage === page;
        link.classList.toggle("bg-sky-500/90", isActive);
        link.classList.toggle("text-white", isActive);
        if (!isActive) {
          link.classList.remove("bg-sky-500/90", "text-white");
        }
      });

      // show the correct page panel
      document.querySelectorAll("[data-page-panel]").forEach(panel => {
        const name = panel.getAttribute("data-page-panel");
        panel.classList.toggle("hidden", name !== page);
      });
    
// 🧠 Special case: AI Chat = no window scrollbar
const isAiChat = page === "ai-chat";
document.documentElement.classList.toggle("ai-chat-mode", isAiChat);
document.body.classList.toggle("ai-chat-mode", isAiChat);

    }



    
    // === SPA Navigation (query param based) ===

    function initSpaNav() {
      const urlParams = new URLSearchParams(window.location.search);
      const initialPage = urlParams.get("page") || "home";
      setActivePage(initialPage);

      // intercept nav clicks
      document.querySelectorAll("[data-nav]").forEach(link => {
        link.addEventListener("click", (e) => {
          e.preventDefault();
          const page = link.getAttribute("data-nav") || "home";
          const url = new URL(window.location.href);
          url.searchParams.set("page", page);
          window.history.pushState({ page }, "", url);
          setActivePage(page);
        });
      });

      // support back/forward buttons
      window.addEventListener("popstate", (event) => {
        const statePage = event.state && event.state.page;
        const url = new URL(window.location.href);
        const page = statePage || url.searchParams.get("page") || "home";
        setActivePage(page);
      });

      // mobile nav toggle (animated full-screen drawer)
      const mobileNavToggle = document.getElementById("mobileNavToggle");
      const mobileNav = document.getElementById("mobileNav");
      const mobileNavClose = document.getElementById("mobileNavClose");
      if (mobileNavToggle && mobileNav) {
        mobileNavToggle.addEventListener("click", () => {
          const isOpen = mobileNav.classList.contains("translate-y-0");

          if (!isOpen) {
            // OPEN: slide in + fade in
            mobileNav.classList.remove("-translate-y-full", "opacity-0", "pointer-events-none");
            mobileNav.classList.add("translate-y-0", "opacity-100", "pointer-events-auto");
          } else {
            // CLOSE: slide out + fade out
            mobileNav.classList.remove("translate-y-0", "opacity-100", "pointer-events-auto");
            mobileNav.classList.add("-translate-y-full", "opacity-0", "pointer-events-none");
          }
        });


        // Close nav when explicit close button is pressed
        if (mobileNavClose) {
          mobileNavClose.addEventListener("click", () => {
            mobileNav.classList.remove("translate-y-0", "opacity-100", "pointer-events-auto");
            mobileNav.classList.add("-translate-y-full", "opacity-0", "pointer-events-none");
          });
        }
        // Close nav when a link is clicked
        mobileNav.querySelectorAll("[data-nav]").forEach((link) => {
          link.addEventListener("click", () => {
            mobileNav.classList.remove("translate-y-0", "opacity-100", "pointer-events-auto");
            mobileNav.classList.add("-translate-y-full", "opacity-0", "pointer-events-none");
          });
        });
      }
    }

let activeDifficulty = "";
    let goodWlOnly       = false;
    let sections         = [];
    let dataLoaded       = false;
    let isLoadingData    = false;
    let subjectAbbrevMap = {};
    let sectionsByCourseKey = new Map();

    // Add/drop deadline + WL model
    const ADD_DROP_DEADLINE       = new Date("2026-01-27T23:59:59-05:00");
    const P_DROP_PER_SEAT_PER_DAY = 0.004;

    function getDaysRemaining() {
      const now = new Date();
      const msPerDay = 1000 * 60 * 60 * 24;
      const diff = (ADD_DROP_DEADLINE - now) / msPerDay;
      return Math.max(0, Math.floor(diff));
    }

    
    // helpers
    function titleCase(str) {
      if (!str) return "";
      return str
        .toLowerCase()
        .split(/\s+/)
        .map(w => w.charAt(0).toUpperCase() + w.slice(1))
        .join(" ");
    }

    // Meeting times → structured chunks
    function parseMeetingTimes(meetingStr) {
      if (!meetingStr || typeof meetingStr !== "string") return [];
      const entries = [];
      const chunks = meetingStr.split("Start Date:").filter(Boolean);
      const pattern = /^(?<days>.*?)SMTWTFS\s*(?<time>.*?)(?:Type:\s*(?<type>.*?))?Building:\s*(?<building>.*?)\s*Room:\s*(?<room>.*)$/i;
      for (const rawChunk of chunks) {
        const chunk = rawChunk.trim();
        if (!chunk) continue;
        const match = chunk.match(pattern);
        if (!match || !match.groups) continue;
        const { days, time, type, building, room } = match.groups;
        entries.push({
          rawDays: (days || "").trim(),
          time:    (time || "").trim(),
          type:    (type || "").trim(),
          building:(building || "").trim(),
          room:    (room || "").trim()
        });
      }
      return entries;
    }

   
    function timeStringToMinutes(part) {
      if (!part || typeof part !== "string") return null;
      const m = part.trim().match(/(\d{1,2}):(\d{2})\s*([AP]M)/i);
      if (!m) return null;
      let hour = parseInt(m[1], 10);
      const minute = parseInt(m[2], 10);
      const mer = m[3].toUpperCase();
      if (mer === "PM" && hour !== 12) hour += 12;
      if (mer === "AM" && hour === 12) hour = 0;
      return hour * 60 + minute;
    }

    function parseTimeRangeToMinutes(rangeStr) {
      if (!rangeStr || typeof rangeStr !== "string") return null;
      const match = rangeStr.match(/(\d{1,2}:\d{2}\s*[AP]M)\s*-\s*(\d{1,2}:\d{2}\s*[AP]M)/i);
      if (!match) return null;
      const startMin = timeStringToMinutes(match[1]);
      const endMin = timeStringToMinutes(match[2]);
      if (startMin == null || endMin == null) return null;
      return { startMin, endMin };
    }

    function deriveMeetingDayKeys(rawDays) {
      if (!rawDays) return [];
      const text = String(rawDays).toLowerCase();
      const result = new Set();
      const map = {
        monday: "Mon", mon: "Mon",
        tuesday: "Tue", tue: "Tue",
        wednesday: "Wed", wed: "Wed",
        thursday: "Thu", thu: "Thu", thur: "Thu",
        friday: "Fri", fri: "Fri",
        saturday: "Sat", sat: "Sat",
        sunday: "Sun", sun: "Sun"
      };
      Object.keys(map).forEach((token) => {
        if (text.includes(token)) {
          result.add(map[token]);
        }
      });
      return Array.from(result);
    }


    // Status → seats + WL
    function parseStatus(raw) {
      const result = {
        seatsRem: null, seatsTot: null,
        wlRem: null, wlTot: null,
        isFull: false, reservedForWaitlist: false
      };
      if (!raw) return result;
      const upper = raw.toUpperCase();
      if (upper.includes("FULL")) result.isFull = true;
      if (upper.includes("OPEN SEATS RESERVED FOR WAITLISTED")) result.reservedForWaitlist = true;
      const seatMatch = raw.match(/(\d+)\s+of\s+(\d+)\s+seats\s+remain/i);
      if (seatMatch) {
        result.seatsRem = parseInt(seatMatch[1], 10);
        result.seatsTot = parseInt(seatMatch[2], 10);
      }
      const wlMatch = raw.match(/(\d+)\s+of\s+(\d+)\s+waitlist\s+seats\s+remain/i);
      if (wlMatch) {
        result.wlRem = parseInt(wlMatch[1], 10);
        result.wlTot = parseInt(wlMatch[2], 10);
      }
      return result;
    }

    // RMP difficulty → bucket + %
    function difficultyFromAvg(avgDiff, numRatings) {
      if (!avgDiff || avgDiff <= 0 || !numRatings || numRatings < 3) {
        return { label: "Limited data", percent: null };
      }
      const norm = (avgDiff - 1) / 4; // 0 → easy, 1 → demanding
      const pct  = Math.round(norm * 100);
      let label;
      if (norm < 0.25)      label = "Easy";
      else if (norm < 0.5)  label = "Moderate";
      else if (norm < 0.75) label = "Challenging";
      else                  label = "Demanding";
      return { label, percent: pct };
    }

    // Poisson tail P(X >= k)
    function poissonTail(k, lambda) {
      if (lambda <= 0) return 0;
      let term  = Math.exp(-lambda);
      let accum = term; // i = 0
      for (let i = 1; i < k; i++) {
        term *= lambda / i;
        accum += term;
      }
      return 1 - accum;
    }

    // Delivery mode classification
    function getDeliveryModeFromMeetings(meetings, campus) {
      const campusLower   = (campus || "").toLowerCase();
      const isOnlineCampus= campusLower.includes("online learning") || campusLower.includes("online");

      let hasPhysical   = false;
      let hasOnlineSync = false;
      let hasOnlineAsync= false;

      meetings.forEach(m => {
        const days      = (m.rawDays || "").trim();
        const time      = (m.time || "").trim();
        const roomUpper = (m.room || "").toUpperCase();
        const isOnlineRoom =
          roomUpper.includes("ON-LINE") ||
          roomUpper.includes("ONLINE") ||
          roomUpper.includes("WEB") ||
          roomUpper.includes("VIRTUAL");

        const hasRealDays = days && days.toLowerCase() !== "none";
        const hasRealTime = time && time !== "-";

        if (!isOnlineRoom && hasRealDays && hasRealTime) {
          hasPhysical = true;
        }
        if (isOnlineRoom && hasRealDays && hasRealTime) {
          hasOnlineSync = true;
        }
        if (isOnlineRoom &&
            (!hasRealDays || days.toLowerCase() === "none") &&
            (!hasRealTime || time === "-")) {
          hasOnlineAsync = true;
        }
      });

      if (isOnlineCampus) {
        if (hasOnlineSync) return { code: "online_sync", label: "Online • Sync" };
        return { code: "online_async", label: "Online • Async" };
      }

      // Physical campus
      if (hasPhysical && hasOnlineSync) {
        return { code: "hybrid_inperson_sync", label: "Hybrid • In-person + Sync" };
      }
      if (hasPhysical && hasOnlineAsync) {
        return { code: "hybrid_inperson_async", label: "Hybrid • In-person + Async" };
      }
      if (hasPhysical && !hasOnlineSync && !hasOnlineAsync) {
        return { code: "in_person", label: "In-person" };
      }

      // fallback (only online segments but non-online campus)
      if (!hasPhysical && (hasOnlineSync || hasOnlineAsync)) {
        return hasOnlineSync
          ? { code: "online_sync", label: "Online • Sync" }
          : { code: "online_async", label: "Online • Async" };
      }

      return { code: "unknown", label: "" };
    }

    // Real-ish WL model
    function estimateRealWaitlistChance(seatsRem, seatsTot, wlRem, wlTot) {
      if (!wlTot || wlTot <= 0 || wlRem === null || wlRem === undefined) return null;
      if (wlRem <= 0) return { label: "Low", percent: 0 };

      const taken = wlTot - wlRem;
      const k = taken + 1;
      const daysRemaining = getDaysRemaining();

      const enrolledNow =
        seatsTot != null && seatsRem != null
          ? Math.max(0, seatsTot - seatsRem)
          : 0;

      let lambda = enrolledNow * P_DROP_PER_SEAT_PER_DAY * daysRemaining;
      if (seatsRem && seatsRem > 0) lambda += seatsRem;

      if (lambda <= 0) return { label: "Low", percent: 0 };

      let p = poissonTail(k, lambda);
      p = Math.max(0, Math.min(0.99, p));

      let label;
      if (p >= 0.85)      label = "Very High";
      else if (p >= 0.65) label = "High";
      else if (p >= 0.35) label = "Moderate";
      else                label = "Low";

      return { label, percent: Math.round(p * 100) };
    }

    
    const DIFFICULTY_BADGE_MAP = {
      "Easy":        "bg-emerald-50 text-emerald-700 border border-emerald-100",
      "Moderate":    "bg-amber-50 text-amber-700 border border-amber-100",
      "Challenging": "bg-violet-50 text-violet-700 border border-violet-100",
      "Demanding":   "bg-rose-50 text-rose-700 border border-rose-100",
    };

    function getDifficultyBadgeClasses(label) {
      return (
        DIFFICULTY_BADGE_MAP[label] ||
        "bg-slate-100 text-slate-700 border border-slate-200"
      );
    }


    const WL_BADGE_MAP = {
      "Very High": "bg-emerald-100 text-emerald-800 border border-emerald-200",
      "High":      "bg-emerald-50 text-emerald-700 border border-emerald-100",
      "Moderate":  "bg-amber-50 text-amber-700 border border-amber-100",
      "Low":       "bg-rose-50 text-rose-700 border border-rose-100",
    };

    function getWaitlistBadgeClasses(label) {
      return (
        WL_BADGE_MAP[label] ||
        "bg-slate-100 text-slate-700 border border-slate-200"
      );
    }


    function getWaitlistTooltip(label) {
      switch (label) {
        case "Very High":
          return "Very likely you’ll get in if you join now, but not guaranteed. Odds are strongly in your favor.";
        case "High":
          return "Good odds you’ll get in, though it’s not guaranteed. You’ve got a strong shot here.";
        case "Moderate":
          return "Could go either way. Hope for the best and keep a backup in mind.";
        case "Low":
          return "Unlikely you’ll get in from the waitlist. Don’t sweat it—treat it as a bonus if it works out.";
        default:
          return "Estimated waitlist odds based on seats, waitlist, and time until add/drop.";
      }
    }

    // Build section object
    function buildSectionObject(row, profMap) {
      const subjectDesc   = row["Subject Description"] || "";
      const courseNumber  = row["Course Number"] ?? "";
      const crn           = row["CRN"];
      const title         = row["Title"] || "";
      const instructorRaw = (row["Instructor"] || "").trim();
      const campus        = row["Campus"] || "";
      const scheduleType  = row["Schedule Type"] || "";
      const statusRaw     = row["Status"] || "";

      const prof = profMap[instructorRaw] || null;

      const meetings = parseMeetingTimes(row["Meeting Times"]);
      let primaryMeeting = null;
      if (meetings.length) {
        primaryMeeting =
          meetings.find(m => m.rawDays && m.rawDays.toLowerCase() !== "none") ||
          meetings[0];
      }

      const meetingDays = primaryMeeting ? (primaryMeeting.rawDays || "TBA") : "TBA";
      const meetingTime = primaryMeeting ? (primaryMeeting.time   || "")    : "";

      const status = parseStatus(statusRaw);

      // Location details (building/room or Online)
      let building = primaryMeeting ? primaryMeeting.building : "";
      let room     = primaryMeeting ? primaryMeeting.room     : "";
      const upperRoom = (room || "").toUpperCase();
      const onlineKeywords = ["ON-LINE", "ONLINE", "WEB", "VIRTUAL"];
      let locationDetail = "";
      if (building && room && !onlineKeywords.includes(upperRoom)) {
        locationDetail = `${titleCase(building)} ${room}`;
      } else if (onlineKeywords.includes(upperRoom)) {
        locationDetail = "Online";
      }

      // Instructor display
      let instructorDisplay = instructorRaw;
      if (prof && prof.cleaned_name) {
        instructorDisplay = prof.cleaned_name;
      } else {
        instructorDisplay = instructorDisplay.replace("(Primary)", "").trim();
      }

      // RMP stats
      let avgRating      = null;
      let numRatings     = null;
      let avgDifficulty  = null;
      let wouldTakeAgain = null;
      let profileUrl     = null;
      let difficultyInfo = { label: "No data", percent: null };

      if (prof) {
        avgRating      = prof.avg_rating || null;
        numRatings     = prof.num_ratings || null;
        avgDifficulty  = prof.avg_difficulty || null;
        wouldTakeAgain = prof.would_take_again_percent || null;
        profileUrl     = prof.profile_url || null;
        difficultyInfo = difficultyFromAvg(avgDifficulty, numRatings);
      }

      // Waitlist logic only when seats full AND WL exists
      const hasWaitlist = status.wlTot && status.wlTot > 0;
      const seatsAreFull =
        (status.seatsRem !== null && status.seatsRem <= 0) || status.isFull;

      const wlChance = hasWaitlist && seatsAreFull
        ? estimateRealWaitlistChance(status.seatsRem, status.seatsTot, status.wlRem, status.wlTot)
        : null;

      // Delivery mode
      const delivery = getDeliveryModeFromMeetings(meetings, campus);

      // Course key & normalized time slots for schedule builder
      const subjectAbbrev =
        subjectAbbrevMap && subjectAbbrevMap[subjectDesc]
          ? subjectAbbrevMap[subjectDesc]
          : null;
      const courseKey =
        subjectAbbrev && courseNumber
          ? subjectAbbrev + " " + String(courseNumber).trim()
          : null;

      const timeSlots = [];
      if (meetings && meetings.length) {
        meetings.forEach((m) => {
          const dayKeys = deriveMeetingDayKeys(m.rawDays || meetingDays);
          const range = parseTimeRangeToMinutes(m.time || meetingTime);
          if (!range || !dayKeys.length) return;
          dayKeys.forEach((dayKey) => {
            timeSlots.push({
              day: dayKey,
              startMin: range.startMin,
              endMin: range.endMin
            });
          });
        });
      }

      return {
        crn,
        title,
        subjectDesc,
        courseNumber,
        instructorDisplay,
        campus,
        meetingDays,
        meetingTime,
        scheduleType,
        statusRaw,
        seatsRem: status.seatsRem,
        seatsTot: status.seatsTot,
        wlRem:    status.wlRem,
        wlTot:    status.wlTot,
        isFull:   status.isFull,
        wlChance,
        avgRating,
        numRatings,
        avgDifficulty,
        wouldTakeAgain,
        profileUrl,
        difficultyLabel:  difficultyInfo.label,
        difficultyPercent:difficultyInfo.percent,
        reservedForWaitlist: status.reservedForWaitlist,
        locationDetail,
        deliveryCode:  delivery.code,
        deliveryLabel: delivery.label,
        subjectAbbrev,
        courseKey,
        timeSlots
      };
    }

    // Load data
    
    async function loadData() {
      if (dataLoaded || isLoadingData) return;

      try {
        isLoadingData = true;
        statusText.textContent = "Loading sections from APIs…";

        //
        // 1) REQUIRED APIs: subjects + prof ratings
        //
        const [subjectsRes, profRes] = await Promise.all([
          fetch(SUBJECTS_API),
          fetch(PROFS_API)
        ]);
        if (!subjectsRes.ok || !profRes.ok) {
          throw new Error("API error loading subjects/profs");
        }

        const subjectsJson = await subjectsRes.json();
        const profJson     = await profRes.json();

        // Build professor map
        const profMap = {};
        (profJson || []).forEach(p => {
          if (p && p.raw_name) {
            profMap[p.raw_name.trim()] = p;
          }
        });

        //
        // 2) OPTIONAL API: subject abbreviations
        //    (fail-soft: warn in console, but do NOT break the UI)
        //
        let abbrevJson = [];
        try {
          const abbrevRes = await fetch(SUBJECT_ABBREV_API);
          if (abbrevRes.ok) {
            abbrevJson = await abbrevRes.json();
          } else {
            console.warn("Abbrev API returned non-OK status:", abbrevRes.status);
          }
        } catch (err) {
          console.warn("Abbrev API fetch failed, continuing without it:", err);
        }

        subjectAbbrevMap = {};
        (abbrevJson || []).forEach(row => {
          const desc = row["Subject Description"];
          const abbr = row["Abbreviation"];
          if (desc && abbr) {
            subjectAbbrevMap[String(desc).trim()] = String(abbr).trim();
          }
        });

        //
        // 3) Build sections + courseKey index
        //
        sections = (subjectsJson || []).map(row => buildSectionObject(row, profMap));

        sectionsByCourseKey = new Map();
        sections.forEach(sec => {
          if (sec && sec.courseKey) {
            if (!sectionsByCourseKey.has(sec.courseKey)) {
              sectionsByCourseKey.set(sec.courseKey, []);
            }
            sectionsByCourseKey.get(sec.courseKey).push(sec);
          }
        });

        //
        // 4) Sort & render
        //
        sections.sort((a, b) => {
          const sA = a.subjectDesc.localeCompare(b.subjectDesc);
          if (sA !== 0) return sA;

          const numA = parseInt(a.courseNumber || 0, 10);
          const numB = parseInt(b.courseNumber || 0, 10);
          if (numA !== numB) return numA - numB;

          return String(a.crn || "").localeCompare(String(b.crn || ""));
        });

        // Update homepage live stats, if present
        try {
          const liveTotalSectionsEl = document.getElementById("liveTotalSections");
          const liveTotalProfsEl    = document.getElementById("liveTotalProfs");
          const liveWlSectionsEl    = document.getElementById("liveWlSections");
          const liveUpdatedAtEl     = document.getElementById("liveUpdatedAt");

          if (liveTotalSectionsEl) {
            liveTotalSectionsEl.textContent = (sections || []).length.toLocaleString();
          }
          if (liveTotalProfsEl) {
            const profCount = Object.keys(profMap || {}).length;
            liveTotalProfsEl.textContent = profCount.toLocaleString();
          }
          if (liveWlSectionsEl) {
            const wlCount = (sections || []).filter(s => s && s.wlChance && s.wlChance.label).length;
            liveWlSectionsEl.textContent = wlCount.toLocaleString();
          }
          if (liveUpdatedAtEl) {
            const now = new Date();
            liveUpdatedAtEl.textContent = now.toLocaleString(undefined, {
              month: "short",
              day: "numeric",
              year: "numeric",
              hour: "numeric",
              minute: "2-digit"
            });
          }
        } catch (e) {
          console.warn("Failed to update homepage live stats:", e);
        }


        dataLoaded = true;
        populateFilters();
        render();
      } catch (err) {
        console.error(err);
        statusText.textContent = "Error loading data. Please refresh.";
      } finally {
        isLoadingData = false;
      }
    }


    function populateFilters() {
      const subjects = new Set();
      const campuses = new Set();
      sections.forEach(s => {
        if (s.subjectDesc) subjects.add(s.subjectDesc);
        if (s.campus)      campuses.add(s.campus);
      });
      subjectFilter.innerHTML =
        '<option value="">All subjects</option>' +
        Array.from(subjects).sort().map(sub => `<option value="${sub}">${sub}</option>`).join("");
      campusFilter.innerHTML =
        '<option value="">All campuses</option>' +
        Array.from(campuses).sort().map(c => `<option value="${c}">${c}</option>`).join("");
    }

    function getFilteredSections() {
      const q      = (searchInput.value || "").toLowerCase().trim();
      const subj   = subjectFilter.value;
      const campus = campusFilter.value;

      return sections.filter(s => {
        if (subj && s.subjectDesc !== subj) return false;
        if (campus && s.campus !== campus) return false;

        if (activeDifficulty && s.difficultyLabel !== activeDifficulty) return false;

        if (goodWlOnly) {
          if (!s.wlChance || (s.wlChance.label !== "High" && s.wlChance.label !== "Very High")) {
            return false;
          }
        }

        if (q) {
          const haystack = [
            s.title,
            s.subjectDesc,
            String(s.courseNumber || ""),
            String(s.crn || ""),
            s.instructorDisplay
          ].join(" ").toLowerCase();
          if (!haystack.includes(q)) return false;
        }
        return true;
      });
    }

    
    function render() {
      const filtered = getFilteredSections();
      statusText.textContent = filtered.length
        ? `${filtered.length.toLocaleString()} of ${sections.length.toLocaleString()} sections shown`
        : "No sections match your filters right now.";

      resultsContainer.innerHTML = "";
      if (!filtered.length) return;

      filtered.forEach((s) => {
        const diffClasses = getDifficultyBadgeClasses(s.difficultyLabel);
        const wlLabel   = s.wlChance ? s.wlChance.label   : null;
        const wlPercent = s.wlChance ? s.wlChance.percent : null;
        const wlClasses = wlLabel ? getWaitlistBadgeClasses(wlLabel) : "";
        const wlTooltip = wlLabel ? getWaitlistTooltip(wlLabel)      : "";

        // Only show waitlist info when seats are full AND a waitlist exists
        const showWaitlist =
          ((s.seatsRem !== null && s.seatsRem <= 0) || s.isFull) &&
          s.wlTot != null && s.wlTot > 0;

        // Seat status label + color
        let seatStatusLabel = "";
        if (s.seatsTot === 0 && s.isFull) {
          seatStatusLabel = "Closed";
        } else if (s.seatsRem !== null) {
          seatStatusLabel =
            s.seatsRem <= 0 || s.isFull
              ? "Full"
              : s.seatsRem <= Math.max(1, Math.round((s.seatsTot || 1) * 0.1))
                ? "Almost full"
                : "Open";
        }

        const seatStatusColor =
          seatStatusLabel === "Open"
            ? "text-emerald-700 bg-emerald-50 border border-emerald-100"
            : seatStatusLabel === "Almost full"
            ? "text-amber-700 bg-amber-50 border border-amber-100"
            : seatStatusLabel === "Full"
            ? "text-rose-700 bg-rose-50 border border-rose-100"
            : "text-slate-600 bg-slate-50 border border-slate-200";

        const ratingText =
          s.avgRating != null && s.numRatings > 0
            ? `${s.avgRating.toFixed(1)} · ${s.avgDifficulty != null ? s.avgDifficulty.toFixed(1) + " diff · " : ""}${s.numRatings} ratings`
            : "No RMP data yet";

        const takeAgainText =
          s.wouldTakeAgain != null && s.wouldTakeAgain !== "" && s.wouldTakeAgain >= 0
            ? `${Math.round(s.wouldTakeAgain)}% would take again`
            : "";

        const rmpLink = s.profileUrl
          ? `<a href="${s.profileUrl}" target="_blank" rel="noopener"
                class="inline-flex items-center gap-1 text-[0.72rem] text-brand-600 hover:text-brand-700">
                View on RMP <i class="fa-solid fa-arrow-up-right-from-square text-[0.65rem]"></i>
             </a>`
          : "";

        let seatsText;
        if (s.seatsTot === 0 && s.isFull) {
          seatsText = "Seats: not open";
        } else if (s.seatsRem == null || s.seatsTot == null) {
          seatsText = "Seats: n/a";
        } else {
          seatsText = `Seats: ${s.seatsTot - s.seatsRem}/${s.seatsTot} filled`;
        }

        const wlText = showWaitlist
          ? `Waitlist: ${s.wlTot - s.wlRem}/${s.wlTot} taken`
          : "";

        const locationParts = [];
        if (s.campus)         locationParts.push(s.campus);
        if (s.locationDetail) locationParts.push(s.locationDetail);
        const locationDisplay = locationParts.join(" • ");

        const deliveryPill = s.deliveryLabel
          ? `<span class="inline-flex items-center gap-1 rounded-full bg-slate-50 text-slate-700 border border-slate-200 px-2.5 py-0.5 text-[0.7rem]">
               <i class="fa-solid fa-laptop text-[0.7rem] text-slate-500"></i>
               <span>${s.deliveryLabel}</span>
             </span>`
          : "";

        const wlPill = (showWaitlist && wlLabel)
          ? `<span class="${wlClasses} inline-flex items-center gap-1 rounded-full px-2.5 py-0.5 text-[0.7rem] font-medium" title="${wlTooltip}">
               <i class="fa-solid fa-ticket text-[0.7rem]"></i>
               <span>${wlLabel}${wlPercent != null ? ` · ${Math.round(wlPercent)}%` : ""}</span>
             </span>`
          : "";

        const diffText =
          s.difficultyPercent != null
            ? `${s.difficultyLabel} · ${Math.round(s.difficultyPercent)}%`
            : s.difficultyLabel;

        const diffPill =
          `<span class="${diffClasses} inline-flex items-center gap-1 rounded-full px-2.5 py-0.5 text-[0.7rem] font-medium">
             <i class="fa-solid fa-gauge text-[0.7rem]"></i>
             <span>${diffText}</span>
           </span>`;

        const seatStatusPill = seatStatusLabel
          ? `<span class="inline-flex items-center gap-1 rounded-full px-2.5 py-0.5 text-[0.7rem] font-medium ${seatStatusColor}">
               <i class="fa-solid fa-circle text-[0.5rem]"></i>
               <span>${seatStatusLabel}</span>
             </span>`
          : "";

        const reservedPill = s.reservedForWaitlist
          ? `<span class="inline-flex items-center gap-1 rounded-full px-2.5 py-0.5 text-[0.7rem] font-medium text-slate-600 bg-slate-50 border border-slate-200">
               <i class="fa-solid fa-lock text-[0.7rem]"></i>
               <span>Seats reserved for waitlist</span>
             </span>`
          : "";

        const card = document.createElement("article");
        card.className =
          "rounded-3xl border border-slate-200/80 bg-white/95 shadow-[0_18px_45px_rgba(15,23,42,0.06)] px-4 py-3.5 md:px-5 md:py-4";

        card.innerHTML = `
          <div class="flex flex-col gap-2.5">
            <!-- Row 1: meta strip -->
            <div class="flex items-center justify-between gap-2">
              <div class="flex items-center gap-2 flex-wrap min-w-0">
                <span class="inline-flex items-center gap-1.5 rounded-full bg-brand-50 text-brand-700 px-2.5 py-0.5 text-[0.7rem] font-semibold tracking-wide uppercase">
                  <span>${s.subjectDesc || "Course"}</span>
                  ${s.courseNumber ? `<span class="text-slate-400">·</span><span>${s.courseNumber}</span>` : ""}
                </span>
                <span class="text-[0.7rem] font-mono text-slate-500">
                  CRN ${s.crn || "—"}
                </span>
              </div>
              <div class="flex items-center gap-1.5">
                ${wlPill || ""}
                ${diffPill}
              </div>
            </div>

            <!-- Row 2: title -->
            <h2 class="text-sm md:text-[0.95rem] font-semibold text-slate-900 leading-snug line-clamp-2">
              ${s.title}
            </h2>

            <!-- Row 3: schedule + location + modality -->
            <div class="flex flex-wrap items-center gap-x-3 gap-y-1 text-[0.78rem] text-slate-600">
              <span class="inline-flex items-center gap-1">
                <i class="fa-regular fa-calendar text-[0.75rem] text-slate-400"></i>
                <span>${s.meetingDays || "TBA"}</span>
              </span>
              ${s.meetingTime ? `
              <span class="inline-flex items-center gap-1">
                <i class="fa-regular fa-clock text-[0.75rem] text-slate-400"></i>
                <span>${s.meetingTime}</span>
              </span>` : ""}
              ${locationDisplay ? `
              <span class="inline-flex items-center gap-1">
                <i class="fa-solid fa-location-dot text-[0.8rem] text-slate-400"></i>
                <span>${locationDisplay}</span>
              </span>` : ""}
              ${deliveryPill}
            </div>

            <!-- Row 4: bottom bar - prof + seats -->
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2 pt-2 border-t border-slate-100 mt-1">
              <div class="flex flex-wrap items-center gap-2 text-[0.78rem] text-slate-700">
                <span class="font-medium text-slate-800 flex items-center gap-1.5">
                  <i class="fa-regular fa-user text-[0.8rem] text-slate-400"></i>
                  <span>${s.instructorDisplay || "TBA"}</span>
                </span>
                <span class="text-slate-300 hidden sm:inline">•</span>
                <span class="inline-flex items-center gap-1 text-slate-600">
                  <i class="fa-solid fa-star text-amber-400 text-[0.7rem]"></i>
                  <span>${ratingText}</span>
                </span>
                ${takeAgainText ? `
                <span class="inline-flex items-center gap-1 text-slate-500">
                  <i class="fa-solid fa-repeat text-[0.7rem]"></i>
                  <span>${takeAgainText}</span>
                </span>` : ""}
                ${rmpLink}
              </div>

              <div class="flex flex-wrap items-center gap-2 text-[0.78rem] text-slate-600">
                <div class="flex items-center gap-1">
                  ${seatStatusPill}
                </div>
                <div class="flex items-center gap-1">
                  <span>${seatsText}</span>
                  ${wlText ? `<span class="text-slate-300">•</span><span>${wlText}</span>` : ""}
                </div>
                ${reservedPill}
              </div>
            </div>
          </div>
        `;

        resultsContainer.appendChild(card);
      });
    }
// listeners
    searchInput.addEventListener("input", render);
    subjectFilter.addEventListener("change", render);
    campusFilter.addEventListener("change", render);

    difficultyChips.forEach(chip => {
      chip.addEventListener("click", () => {
        const selected = chip.getAttribute("data-diff") || "";
        activeDifficulty = (activeDifficulty === selected) ? "" : selected;
        difficultyChips.forEach(c => {
          const val = c.getAttribute("data-diff") || "";
          if (val === activeDifficulty) c.classList.add("chip-active");
          else c.classList.remove("chip-active");
        });
        render();
      });
    });

    clearDifficultyBtn.addEventListener("click", () => {
      activeDifficulty = "";
      difficultyChips.forEach(c => c.classList.remove("chip-active"));
      render();
    });

    wlToggle.addEventListener("click", () => {
      wlToggle.classList.toggle("bg-brand-600");
      wlToggle.classList.toggle("border-brand-600");
      const dot = wlToggle.querySelector(".dot");
      const active = wlToggle.classList.contains("bg-brand-600");
      goodWlOnly = active;
      if (active) {
        dot.classList.remove("translate-x-1", "bg-slate-300");
        dot.classList.add("translate-x-5", "bg-white");
      } else {
        dot.classList.remove("translate-x-5", "bg-white");
        dot.classList.add("translate-x-1", "bg-slate-300");
      }
      render();
    });

    
    
    // === Advisement PDF parsing (Schedule Builder) ===
// === PDF course extraction helpers ===
    function fileToArrayBuffer(file) {
      return file.arrayBuffer();
    }

    async function extractFullTextFromPdf(data, pdfjs) {
      const loadingTask = pdfjs.getDocument({ data });
      const pdf = await loadingTask.promise;

      let fullText = "";

      for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
        const page = await pdf.getPage(pageNum);
        const textContent = await page.getTextContent();
        const pageText = textContent.items.map((item) => item.str).join(" ");
        fullText += pageText + "\n";
      }

      return fullText.trim();
    }

    function findMarkerIndex(text, marker, fromIndex = 0) {
      if (typeof marker === "string") {
        return text.indexOf(marker, fromIndex);
      } else if (marker instanceof RegExp) {
        const sliced = text.slice(fromIndex);
        const match = sliced.match(marker);
        if (!match) return -1;
        return fromIndex + match.index;
      }
      throw new Error("marker must be string or RegExp");
    }

    function getMarkerLength(text, marker) {
      if (typeof marker === "string") {
        return marker.length;
      } else if (marker instanceof RegExp) {
        const match = text.match(marker);
        return match ? match[0].length : 0;
      }
      throw new Error("marker must be string or RegExp");
    }

    function extractSection(fullText, startMarker, endMarker = null) {
      let sectionText = fullText;

      const startIdx = findMarkerIndex(fullText, startMarker);
      if (startIdx !== -1) {
        const afterStart = startIdx + getMarkerLength(fullText, startMarker);

        if (endMarker != null) {
          const endIdx = findMarkerIndex(fullText, endMarker, afterStart);
          if (endIdx !== -1) {
            sectionText = fullText.slice(afterStart, endIdx);
          } else {
            sectionText = fullText.slice(afterStart);
          }
        } else {
          sectionText = fullText.slice(afterStart);
        }
      }

      return sectionText;
    }

    function splitIntoRoughLines(sectionText) {
      return sectionText
        .split(/\n/)
        .map((line) => line.trim())
        .filter(Boolean);
    }

    function explodeNumberedLines(lines) {
      const result = [];

      lines.forEach((line) => {
        const parts = line.split(/(?=\d+[\.\)]\s)/);
        parts.forEach((part) => {
          const trimmed = part.trim();
          if (trimmed) result.push(trimmed);
        });
      });

      return result;
    }

    function extractNumberedCourseLines(lines) {
      const result = [];

      lines.forEach((line) => {
        const match = line.match(/^(\d+[\.\)])\s*(.*)$/);
        if (match) {
          const courseText = match[2].trim();
          if (courseText) result.push(courseText);
        }
      });

      return result;
    }

    async function extractCoursesFromPdfFile(
      file,
      {
        pdfjs,
        startMarker = "Part 2: Desired Course Selection",
        endMarker = "Part 2A",
      } = {}
    ) {
      if (!pdfjs || typeof pdfjs.getDocument !== "function") {
        throw new Error("You must pass a valid PDF.js object via options.pdfjs");
      }

      const arrayBuffer = await fileToArrayBuffer(file);
      const fullText = await extractFullTextFromPdf(arrayBuffer, pdfjs);
      const sectionText = extractSection(fullText, startMarker, endMarker);
      const roughLines = splitIntoRoughLines(sectionText);

      const explodedLines = explodeNumberedLines(roughLines);
      const courses = extractNumberedCourseLines(explodedLines);

      return { courses, fullText, sectionText };
    }

    function parseCourseLineToObject(line) {
      const raw = String(line || "").trim();
      if (!raw) return null;

      // Match patterns like "ACC 2338", "MTH-1023", "ACC2338" at the start
      const match = raw.match(/^([A-Z]{2,4})\s*-?\s*(\d{3,4}[A-Z]?)/);
      if (match) {
        const subjectAbbrev = match[1];
        const courseNumber = match[2];
        const courseKey = subjectAbbrev + " " + courseNumber;
        const title = raw.slice(match[0].length).trim();
        return {
          raw,
          type: "named",
          subjectAbbrev,
          courseNumber,
          courseKey,
          title
        };
      }

      // Fallback bucket (electives / generic requirements we couldn't parse)
      return {
        raw,
        type: "placeholder",
        subjectAbbrev: null,
        courseNumber: null,
        courseKey: null,
        title: raw
      };
    }

    // === Schedule Builder page wiring ===
    const builderPdfInput = document.getElementById("builderPdfInput");
    const builderRunBtn = document.getElementById("builderRunBtn");
    const builderFileName = document.getElementById("builderFileName");
    const builderCourseList = document.getElementById("builderCourseList");
    const builderSectionDebug = document.getElementById("builderSectionDebug");
    const builderCountBadge = document.getElementById("builderCountBadge");
    const generateScheduleBtn = document.getElementById("generateScheduleBtn");
    const scheduleOptionsContainer = document.getElementById("scheduleOptionsContainer");
    const scheduleHelperText = document.getElementById("scheduleHelperText");

    let builderSelectedFile = null;
    let builderDetectedCoursesRaw = [];
    let builderParsedCourses = [];

    if (builderPdfInput && builderRunBtn) {
      builderPdfInput.addEventListener("change", (e) => {
        builderSelectedFile = e.target.files?.[0] || null;

        if (builderSelectedFile) {
          builderFileName.textContent = builderSelectedFile.name;
          builderRunBtn.disabled = false;
        } else {
          builderFileName.textContent = "No file selected yet.";
          builderRunBtn.disabled = true;
        }

        builderCourseList.innerHTML =
          '<li class="text-xs text-slate-400">Ready when you are — click “Extract courses”.</li>';
        if (builderSectionDebug) {
          builderSectionDebug.textContent = "";
        }
        if (builderCountBadge) {
          builderCountBadge.classList.add("hidden");
          builderCountBadge.textContent = "";
        }
      });

      builderRunBtn.addEventListener("click", async () => {
        if (!builderSelectedFile) return;

        builderRunBtn.disabled = true;
        builderRunBtn.innerHTML =
          '<i class="fa-solid fa-spinner fa-spin text-[0.8rem]"></i><span>Extracting…</span>';

        builderCourseList.innerHTML =
          '<li class="text-xs text-slate-500">Processing PDF… this stays in your browser.</li>';
        if (builderSectionDebug) {
          builderSectionDebug.textContent = "";
        }

        try {
          const { courses, sectionText } = await extractCoursesFromPdfFile(
            builderSelectedFile,
            {
              pdfjs: pdfjsLib,
              startMarker: "Part 2: Desired Course Selection",
              endMarker: "Part 2A",
            }
          );

          // store parsed courses for schedule generation
          builderDetectedCoursesRaw = courses.slice();
          builderParsedCourses = courses
            .map(parseCourseLineToObject)
            .filter(Boolean);

          builderCourseList.innerHTML = "";

          if (!courses.length) {
            builderCourseList.innerHTML =
              '<li class="text-xs text-rose-500">No numbered course lines found in “Part 2”. Double-check that this is the right advisement form.</li>';
          } else {
            courses.forEach((course, index) => {
              const li = document.createElement("li");
              li.className =
                "flex items-start gap-2 rounded-2xl border border-slate-100 bg-slate-50 px-3 py-2 text-[0.8rem] text-slate-800";
              li.innerHTML = `
                <span class="mt-0.5 text-[0.7rem] text-slate-400">${index + 1}.</span>
                <span>${course}</span>
              `;
              builderCourseList.appendChild(li);
            });
          }

          if (builderSectionDebug) {
            builderSectionDebug.textContent = sectionText || "(No section text found.)";
          }

          if (builderCountBadge) {
            builderCountBadge.textContent =
              courses.length === 1
                ? "1 course detected"
                : `${courses.length} courses detected`;
            builderCountBadge.classList.toggle("hidden", courses.length === 0);
          }
        } catch (err) {
          console.error(err);
          builderCourseList.innerHTML =
            '<li class="text-xs text-rose-500">Error extracting courses. Open the console for details.</li>';
        } finally {
          builderRunBtn.disabled = !builderSelectedFile;
          builderRunBtn.innerHTML =
            '<i class="fa-solid fa-wand-magic-sparkles text-[0.8rem]"></i><span>Find my classes</span>';
        }

      });
    }

    // Hook up schedule generation button
    if (generateScheduleBtn && scheduleOptionsContainer) {
      generateScheduleBtn.addEventListener("click", async () => {
        const originalLabel = generateScheduleBtn.innerHTML;
        generateScheduleBtn.disabled = true;
        generateScheduleBtn.innerHTML =
          '<i class="fa-solid fa-spinner fa-spin text-[0.8rem]"></i><span>Generating…</span>';

        try {
          await loadData();

          if (!builderParsedCourses || builderParsedCourses.length === 0) {
            scheduleOptionsContainer.innerHTML =
              '<div class="text-rose-200 text-[0.72rem]">No parsed courses found yet. Upload your advisement PDF and click “Extract courses” first.</div>';
            return;
          }

          const namedCourses = builderParsedCourses.filter(c => c.type === "named" && c.courseKey);
          const placeholders = builderParsedCourses.filter(c => c.type === "placeholder" || !c.courseKey);

          if (namedCourses.length === 0) {
            scheduleOptionsContainer.innerHTML =
              '<div class="text-rose-200 text-[0.72rem]">We couldn’t recognize any standard course numbers (like “ACC 2338”). You can still use this section as notes, but schedule generation needs course numbers.</div>';
            return;
          }

          const courseEntries = [];

          namedCourses.forEach(course => {
            const sectionsForCourse = sectionsByCourseKey.get(course.courseKey) || [];
            if (!sectionsForCourse.length) return;

            const scored = sectionsForCourse.map(sec => {
              const score = scoreSectionOverall(sec);
              return { section: sec, score };
            });

            scored.sort((a, b) => b.score.total - a.score.total);

            courseEntries.push({
              course,
              candidates: scored.slice(0, 8)
            });
          });

          if (!courseEntries.length) {
            scheduleOptionsContainer.innerHTML =
              '<div class="text-rose-200 text-[0.72rem]">None of the detected courses matched actual Spring 2026 sections. Double-check that your advisement sheet is for Spring 2026.</div>';
            return;
          }

          const chosen = buildGreedySchedule(courseEntries);

          renderScheduleOptions({
            courseEntries,
            chosen,
            placeholders
          });
        } catch (err) {
          console.error(err);
          scheduleOptionsContainer.innerHTML =
            '<div class="text-rose-200 text-[0.72rem]">Error generating schedules. Open the console for details.</div>';
        } finally {
          generateScheduleBtn.disabled = false;
          generateScheduleBtn.innerHTML = originalLabel;
        }
      });
    }

    // === Time preferences model & helpers ===
    const TIME_GRID_DAYS = ["Mon", "Tue", "Wed", "Thu", "Fri"];
    const TIME_START_MIN = 6 * 60;        // 6:00 AM
    const TIME_END_MIN   = 23 * 60;       // 11:00 PM
    const SLOT_MINUTES   = 30;
    const GRID_SLOT_MINUTES = 60;

    const timePrefsModel = {
      selectedDays: new Set(),
      defaultWindow: { start: 9 * 60, end: 16 * 60 },
      dayOverrides: {}
    };

    function minutesToDisplay(mins) {
      const h24 = Math.floor(mins / 60);
      const m = mins % 60;
      const period = h24 >= 12 ? "PM" : "AM";
      const h12 = ((h24 + 11) % 12) + 1;
      const mm = String(m).padStart(2, "0");
      return `${h12}:${mm} ${period}`;
    }

    function normalizeWindow(start, end, minDuration = SLOT_MINUTES) {
      let s = Math.max(TIME_START_MIN, Math.min(TIME_END_MIN, start));
      let e = Math.max(TIME_START_MIN, Math.min(TIME_END_MIN, end));
      if (e <= s) {
        e = s + minDuration;
        if (e > TIME_END_MIN) {
          e = TIME_END_MIN;
          s = e - minDuration;
        }
      }
      return { start: s, end: e };
    }

    function setSelectedDays(dayKeys) {
      timePrefsModel.selectedDays = new Set(dayKeys);
    }

    function toggleDayKey(dayKey) {
      if (timePrefsModel.selectedDays.has(dayKey)) {
        timePrefsModel.selectedDays.delete(dayKey);
      } else {
        timePrefsModel.selectedDays.add(dayKey);
      }
    }

    function setDefaultWindow(start, end) {
      const { start: s, end: e } = normalizeWindow(start, end);
      timePrefsModel.defaultWindow.start = s;
      timePrefsModel.defaultWindow.end = e;
    }

    function setDayOverride(dayKey, start, end) {
      const { start: s, end: e } = normalizeWindow(start, end);
      timePrefsModel.dayOverrides[dayKey] = { start: s, end: e };
    }

    function clearDayOverride(dayKey) {
      delete timePrefsModel.dayOverrides[dayKey];
    }

    function getWindowForDay(dayKey) {
      if (timePrefsModel.dayOverrides[dayKey]) {
        return timePrefsModel.dayOverrides[dayKey];
      }
      return timePrefsModel.defaultWindow;
    }

    function isGridCellPreferred(dayKey, slotStartMinutes) {
      if (!timePrefsModel.selectedDays.has(dayKey)) return false;
      const { start, end } = getWindowForDay(dayKey);
      const slotEnd = slotStartMinutes + GRID_SLOT_MINUTES;
      return slotStartMinutes < end && slotEnd > start;
    }

    function generateTimeGrid() {
      const rows = [];
      for (let mins = TIME_START_MIN; mins <= TIME_END_MIN; mins += GRID_SLOT_MINUTES) {
        const timeLabel = minutesToDisplay(mins);
        const cells = TIME_GRID_DAYS.map((dayKey) => ({
          dayKey,
          isPreferred: isGridCellPreferred(dayKey, mins)
        }));
        rows.push({ timeLabel, startMinutes: mins, cells });
      }
      return rows;
    }

    function getTimeSummary() {
      if (timePrefsModel.selectedDays.size === 0) {
        return "Select at least one day and a time range.";
      }
      const dayList = Array.from(timePrefsModel.selectedDays);
      const dayText = dayList.join(", ");
      const def = timePrefsModel.defaultWindow;
      let summary = `${dayText} • Default ${minutesToDisplay(def.start)} – ${minutesToDisplay(def.end)}`;

      const customDays = Object.keys(timePrefsModel.dayOverrides).filter((d) =>
        timePrefsModel.selectedDays.has(d)
      );
      if (customDays.length > 0) {
        summary += ` (custom on ${customDays.join(", ")})`;
      }
      return summary;
    }

    
    // === Time Preference Builder (Schedule Builder) ===

    function initTimePrefsUI() {
      const dayButtons = document.querySelectorAll(".time-day-pill");
      const fromSelect = document.getElementById("timeDefaultFrom");
      const toSelect = document.getElementById("timeDefaultTo");
      const gridBody = document.getElementById("timeGridBody");
      const summaryEl = document.getElementById("timeSummaryText");

      if (!fromSelect || !toSelect || !gridBody || !summaryEl || !dayButtons.length) {
        return;
      }

      // populate dropdowns with 30-min increments
      function populateTimeSelect(selectEl) {
        selectEl.innerHTML = "";
        for (let mins = TIME_START_MIN; mins <= TIME_END_MIN; mins += SLOT_MINUTES) {
          const opt = document.createElement("option");
          opt.value = String(mins);
          opt.textContent = minutesToDisplay(mins);
          selectEl.appendChild(opt);
        }
      }
      populateTimeSelect(fromSelect);
      populateTimeSelect(toSelect);

      // default state: Mon–Thu selected, 9–4
      setSelectedDays(["Mon", "Tue", "Wed", "Thu"]);
      setDefaultWindow(9 * 60, 16 * 60);
      fromSelect.value = String(timePrefsModel.defaultWindow.start);
      toSelect.value = String(timePrefsModel.defaultWindow.end);

      // sync day button styles
      function syncDayButtons() {
        dayButtons.forEach((btn) => {
          const key = btn.getAttribute("data-day-key");
          const isOn = timePrefsModel.selectedDays.has(key);
          btn.classList.toggle("bg-sky-500", isOn);
          btn.classList.toggle("text-white", isOn);
          btn.classList.toggle("border-slate-200", !isOn);
          btn.classList.toggle("bg-slate-50", !isOn);
          btn.classList.toggle("text-slate-700", !isOn);
        });
      }

      dayButtons.forEach((btn) => {
        const key = btn.getAttribute("data-day-key");
        btn.addEventListener("click", () => {
          toggleDayKey(key);
          syncDayButtons();
          renderTimeGrid();
        });
      });

      function handleDefaultChange() {
        const start = parseInt(fromSelect.value, 10);
        const end = parseInt(toSelect.value, 10);
        setDefaultWindow(start, end);
        // also nudge per-day dropdowns if they use default
        syncCustomRows();
        renderTimeGrid();
      }

      fromSelect.addEventListener("change", handleDefaultChange);
      toSelect.addEventListener("change", handleDefaultChange);

      // custom per-day rows
      function syncCustomRows() {
        TIME_GRID_DAYS.forEach((dayKey) => {
          const row = document.querySelector(`[data-time-row="${dayKey}"]`);
          if (!row) return;
          const toggle = row.querySelector(`[data-time-custom-toggle="${dayKey}"]`);
          const from = row.querySelector(`[data-time-custom-from="${dayKey}"]`);
          const to = row.querySelector(`[data-time-custom-to="${dayKey}"]`);

          if (!from.options.length) {
            // populate once
            [from, to].forEach((sel) => {
              populateTimeSelect(sel);
            });
          }

          if (!toggle.checked) {
            clearDayOverride(dayKey);
            from.disabled = true;
            to.disabled = true;
            // keep selects in sync with default
            from.value = String(timePrefsModel.defaultWindow.start);
            to.value = String(timePrefsModel.defaultWindow.end);
          } else {
            from.disabled = false;
            to.disabled = false;
            const start = parseInt(from.value, 10);
            const end = parseInt(to.value, 10);
            setDayOverride(dayKey, start, end);
          }
        });
      }

      TIME_GRID_DAYS.forEach((dayKey) => {
        const row = document.querySelector(`[data-time-row="${dayKey}"]`);
        if (!row) return;
        const toggle = row.querySelector(`[data-time-custom-toggle="${dayKey}"]`);
        const from = row.querySelector(`[data-time-custom-from="${dayKey}"]`);
        const to = row.querySelector(`[data-time-custom-to="${dayKey}"]`);

        // initialize selects with default window
        [from, to].forEach((sel) => {
          populateTimeSelect(sel);
        });
        from.value = String(timePrefsModel.defaultWindow.start);
        to.value = String(timePrefsModel.defaultWindow.end);

        const handler = () => {
          syncCustomRows();
          renderTimeGrid();
        };
        toggle.addEventListener("change", handler);
        from.addEventListener("change", handler);
        to.addEventListener("change", handler);
      });

      function renderTimeGrid() {
        const grid = generateTimeGrid();
        gridBody.innerHTML = "";
        grid.forEach((row) => {
          const tr = document.createElement("tr");
          const timeCell = document.createElement("td");
          timeCell.className = "px-2 py-1 border-t border-slate-100 text-right align-middle text-[0.7rem] text-slate-400";
          timeCell.textContent = row.timeLabel;
          tr.appendChild(timeCell);

          row.cells.forEach((cell) => {
            const td = document.createElement("td");
            td.className = "px-1 py-0.5 border-t border-slate-100 align-middle";
            const div = document.createElement("div");
            div.className = "h-5 rounded-md";
            if (cell.isPreferred) {
              div.classList.add("bg-sky-500", "bg-opacity-90");
            } else {
              div.classList.add("bg-transparent");
            }
            td.appendChild(div);
            tr.appendChild(td);
          });

          gridBody.appendChild(tr);
        });

        summaryEl.textContent = getTimeSummary();
      }

      // initial render
      syncDayButtons();
      syncCustomRows();
      renderTimeGrid();
    }

    
    // === Schedule scoring & rendering helpers ===
    const DAY_KEY_LABELS = {
      Mon: "Monday",
      Tue: "Tuesday",
      Wed: "Wednesday",
      Thu: "Thursday",
      Fri: "Friday",
      Sat: "Saturday",
      Sun: "Sunday"
    };

    function getPreferredWindowForDay(dayKey) {
      const override = timePrefsModel.dayOverrides[dayKey];
      if (override) return { start: override.start, end: override.end };
      return {
        start: timePrefsModel.defaultWindow.start,
        end: timePrefsModel.defaultWindow.end
      };
    }

    function scoreSectionTimeFit(section) {
      if (!section.timeSlots || !section.timeSlots.length || timePrefsModel.selectedDays.size === 0) {
        return 0;
      }
      let score = 0;
      let counted = 0;

      section.timeSlots.forEach((slot) => {
        const dayKey = slot.day;
        if (!dayKey) return;

        if (!timePrefsModel.selectedDays.has(dayKey)) {
          // class meets on a day the student didn't select
          score -= 2;
          return;
        }

        const pref = getPreferredWindowForDay(dayKey);
        const slotStart = slot.startMin;
        const slotEnd = slot.endMin;

        const overlapStart = Math.max(pref.start, slotStart);
        const overlapEnd = Math.min(pref.end, slotEnd);

        if (overlapEnd <= overlapStart) {
          // no overlap, penalize by distance
          const delta =
            slotStart > pref.end
              ? slotStart - pref.end
              : pref.start - slotEnd;
          score -= Math.min(4, delta / 30); // up to -4 pts based on distance in 30‑min steps
        } else {
          const overlap = overlapEnd - overlapStart;
          const span = Math.max(1, slotEnd - slotStart);
          const ratio = overlap / span; // 0–1
          score += ratio * 4; // up to +4 pts for perfect overlap
        }

        counted++;
      });

      if (!counted) return score;
      return score / counted;
    }

    function scoreSectionEase(section) {
      const diffPercent =
        typeof section.difficultyPercent === "number"
          ? section.difficultyPercent
          : 50;
      const baseEase = 100 - diffPercent; // higher = easier

      let bonus = 0;
      if (section.avgRating != null) {
        bonus += (section.avgRating - 2.5); // tiny nudge
      }
      if (section.wouldTakeAgain != null) {
        bonus += section.wouldTakeAgain / 25; // up to ~4 pts
      }
      return baseEase / 10 + bonus; // rough 0–20 range
    }

    function scoreSectionAvailability(section) {
      if (!section.isFull) return 5; // open seats
      if (section.wlChance == null) return 0;
      if (section.wlChance >= 0.7) return 3;
      if (section.wlChance >= 0.4) return 2;
      if (section.wlChance >= 0.2) return 1;
      return 0;
    }

    function scoreSectionOverall(section) {
      const timeScore = scoreSectionTimeFit(section);
      const easeScore = scoreSectionEase(section);
      const availScore = scoreSectionAvailability(section);
      return {
        timeScore,
        easeScore,
        availScore,
        total: timeScore * 1.5 + easeScore + availScore
      };
    }

    function sectionsConflict(a, b) {
      if (!a.timeSlots || !b.timeSlots) return false;
      for (const slotA of a.timeSlots) {
        for (const slotB of b.timeSlots) {
          if (!slotA.day || !slotB.day) continue;
          if (slotA.day !== slotB.day) continue;
          if (slotA.startMin < slotB.endMin && slotB.startMin < slotA.endMin) {
            return true;
          }
        }
      }
      return false;
    }

    function buildGreedySchedule(courseEntries) {
      const chosen = [];
      courseEntries.forEach((entry) => {
        const { candidates } = entry;
        for (const c of candidates) {
          const sec = c.section;
          const hasConflict = chosen.some((already) => sectionsConflict(already, sec));
          if (!hasConflict) {
            chosen.push(sec);
            break;
          }
        }
      });
      return chosen;
    }

    function renderScheduleOptions({ courseEntries, chosen, placeholders }) {
      if (!scheduleOptionsContainer) return;

      const byCrn = new Set(chosen.map((s) => s.crn));

      const lines = [];

      // Summary header
      const totalCourses = courseEntries.length + (placeholders ? placeholders.length : 0);
      lines.push(`
        <div class="rounded-2xl border border-emerald-500/40 bg-emerald-900/40 p-3 flex flex-col gap-1">
          <div class="flex items-center gap-2 text-[0.78rem]">
            <span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-emerald-500/30 text-emerald-50 text-[0.65rem]">
              <i class="fa-solid fa-sparkles"></i>
            </span>
            <span class="font-semibold text-emerald-50">
              Prototype schedule (greedy fit)
            </span>
          </div>
          <p class="text-[0.7rem] text-emerald-100/90">
            We picked one section per detected course, preferring easier professors, stronger waitlist odds, and classes inside your chosen time windows.
          </p>
          <p class="text-[0.7rem] text-emerald-100/80">
            Courses covered: ${chosen.length} of ${totalCourses}.
          </p>
        </div>
      `);

      // Per‑course cards
      courseEntries.forEach((entry) => {
        const { course, candidates } = entry;
        if (!candidates.length) return;
        const best = candidates[0].section;
        const picked = chosen.find((s) => s.crn === best.crn) || best;
        const pickedScore = scoreSectionOverall(picked);

        const days = picked.meetingDays || "TBA";
        const time = picked.meetingTime || "";
        const statusLabel = picked.isFull
          ? (picked.wlRem != null && picked.wlTot != null
              ? `Waitlist: ${picked.wlRem} of ${picked.wlTot} spots left`
              : "Section full")
          : (picked.seatsRem != null && picked.seatsTot != null
              ? `Seats: ${picked.seatsRem} of ${picked.seatsTot} open`
              : "Open");

        lines.push(`
          <div class="rounded-2xl border border-slate-800/60 bg-slate-900/60 p-3">
            <div class="flex items-center justify-between gap-2">
              <div>
                <div class="text-[0.75rem] font-semibold text-slate-50">
                  ${course.courseKey || course.raw}
                </div>
                <div class="text-[0.7rem] text-slate-300">
                  ${picked.title || ""}
                </div>
                <div class="mt-1 text-[0.7rem] text-slate-300/90">
                  <span class="inline-flex items-center gap-1">
                    <i class="fa-regular fa-clock text-[0.65rem]"></i>
                    <span>${days} • ${time || "TBA"}</span>
                  </span>
                  ${picked.locationDetail ? ` · <span>${picked.locationDetail}</span>` : ""}
                </div>
              </div>
              <div class="text-right text-[0.68rem] text-slate-300 space-y-0.5">
                <div>
                  <span class="inline-flex items-center gap-1">
                    <i class="fa-regular fa-user text-[0.65rem]"></i>
                    <span>${picked.instructorDisplay || "TBA"}</span>
                  </span>
                </div>
                <div class="text-[0.65rem] text-slate-400">
                  Diff: ${picked.difficultyLabel || "Unknown"}
                  ${picked.avgRating ? ` · Rating: ${picked.avgRating.toFixed(1)}` : ""}
                  ${picked.numRatings ? ` (${picked.numRatings} ratings)` : ""}
                </div>
                <div class="text-[0.65rem] ${picked.isFull ? "text-amber-300" : "text-emerald-300"}">
                  ${statusLabel}
                </div>
              </div>
            </div>
            <div class="mt-1 flex flex-wrap gap-2 text-[0.62rem] text-slate-300/90">
              <span class="inline-flex items-center gap-1 rounded-full bg-slate-800/80 px-2 py-0.5">
                <span class="w-1.5 h-1.5 rounded-full bg-emerald-400"></span>
                <span>Time fit: ${pickedScore.timeScore.toFixed(1)}</span>
              </span>
              <span class="inline-flex items-center gap-1 rounded-full bg-slate-800/80 px-2 py-0.5">
                <span class="w-1.5 h-1.5 rounded-full bg-sky-400"></span>
                <span>Ease: ${pickedScore.easeScore.toFixed(1)}</span>
              </span>
              <span class="inline-flex items-center gap-1 rounded-full bg-slate-800/80 px-2 py-0.5">
                <span class="w-1.5 h-1.5 rounded-full bg-amber-400"></span>
                <span>Availability: ${pickedScore.availScore.toFixed(1)}</span>
              </span>
            </div>
          </div>
        `);
      });

      if (placeholders && placeholders.length) {
        lines.push(`
          <div class="mt-1 rounded-2xl border border-slate-800/60 bg-slate-900/40 p-3 text-[0.7rem] text-slate-200">
            <div class="font-semibold mb-1">Unstructured items</div>
            <p class="text-[0.68rem] text-slate-300/90 mb-1">
              We found ${placeholders.length} line(s) we treated as generic electives or notes:
            </p>
            <ul class="list-disc pl-4 space-y-0.5">
              ${placeholders
                .map((p) => `<li class="text-[0.68rem] text-slate-200">${p.raw}</li>`)
                .join("")}
            </ul>
          </div>
        `);
      }

      scheduleOptionsContainer.innerHTML = lines.join("");
    }


    // === Schedule Optimizer page wiring ===
    
  // ===============================
  // OCR TABLE RECONSTRUCTION (GUIDE-BASED)
  // ===============================
  async function extractTableFromImage(fileOrBlob, colPct = 5, rowPct = 3) {
    // 1) OCR words from Tesseract
    const { data } = await Tesseract.recognize(fileOrBlob, "eng", {
      logger: (m) => console.log("[OCR]", m),
    });

    let words = (data.words || []).filter((w) => (w.text || "").trim().length > 0);

    // 2) Normalize words (cx, cy)
    words = words.map((w) => ({
      ...w,
      cx: (w.bbox.x0 + w.bbox.x1) / 2,
      cy: (w.bbox.y0 + w.bbox.y1) / 2,
    }));

    if (!words.length) return [];

    // 3) Estimate image size from bboxes
    const imageWidth = Math.max(...words.map((w) => w.bbox.x1));
    const imageHeight = Math.max(...words.map((w) => w.bbox.y1));

    // 4) Convert threshold percentages to pixels
    const colThreshold = (colPct / 100) * imageWidth;
    const rowThreshold = (rowPct / 100) * imageHeight;

    // 5) Cluster columns (sweep on cx)
    const sortedX = [...words].sort((a, b) => a.cx - b.cx);
    const colCenters = [];
    sortedX.forEach((w) => {
      const last = colCenters[colCenters.length - 1];
      if (!last || Math.abs(w.cx - last) > colThreshold) colCenters.push(w.cx);
      else {
        const i = colCenters.length - 1;
        colCenters[i] = (colCenters[i] + w.cx) / 2;
      }
    });

    // Assign nearest column to each word
    words.forEach((w) => {
      let best = 0,
        dist = Infinity;
      colCenters.forEach((c, i) => {
        const d = Math.abs(w.cx - c);
        if (d < dist) {
          dist = d;
          best = i;
        }
      });
      w.col = best;
    });

    // 6) Cluster rows (sweep on cy)
    const sortedY = [...words].sort((a, b) => a.cy - b.cy);
    const rowCenters = [];
    sortedY.forEach((w) => {
      const last = rowCenters[rowCenters.length - 1];
      if (!last || Math.abs(w.cy - last) > rowThreshold) rowCenters.push(w.cy);
      else {
        const i = rowCenters.length - 1;
        rowCenters[i] = (rowCenters[i] + w.cy) / 2;
      }
    });

    // Assign nearest row to each word
    words.forEach((w) => {
      let best = 0,
        dist = Infinity;
      rowCenters.forEach((r, i) => {
        const d = Math.abs(w.cy - r);
        if (d < dist) {
          dist = d;
          best = i;
        }
      });
      w.row = best;
    });

    // 7) Build the 2D cell matrix
    const rowCount = rowCenters.length;
    const colCount = colCenters.length;

    const cells = Array.from({ length: rowCount }, () =>
      Array.from({ length: colCount }, () => "")
    );

    words.forEach((w) => {
      const r = w.row,
        c = w.col;
      if (!cells[r][c]) cells[r][c] = w.text;
      else cells[r][c] += " " + w.text;
    });

    return cells;
  }

  // ===============================
  // CRN COLUMN DETECTION + EXTRACTION
  // ===============================
  function detectHeaderRowIndex(cells) {
    let bestIdx = 0,
      bestScore = -1;
    const scanRows = Math.min(3, cells.length);

    for (let r = 0; r < scanRows; r++) {
      const rowText = (cells[r] || []).join(" ").toLowerCase();
      const score =
        (rowText.includes("crn") ? 3 : 0) +
        (rowText.includes("course") ? 1 : 0) +
        (rowText.includes("section") || rowText.includes("sec") ? 1 : 0);

      if (score > bestScore) {
        bestScore = score;
        bestIdx = r;
      }
    }
    return bestIdx;
  }

  function findCrnColumnIndex(cells, headerRowIdx) {
    const header = cells[headerRowIdx] || [];
    let crnCol = header.findIndex((cell) => /crn/i.test(cell || ""));

    if (crnCol !== -1) return crnCol;

    // Fallback: pick the column with the most CRN-looking numbers under it
    let bestCol = -1,
      bestHits = -1;
    const colCount = header.length;

    for (let c = 0; c < colCount; c++) {
      let hits = 0;
      for (let r = headerRowIdx + 1; r < cells.length; r++) {
        const v = String((cells[r] || [])[c] || "");
        if (/\b\d{4,6}\b/.test(v)) hits++;
      }
      if (hits > bestHits) {
        bestHits = hits;
        bestCol = c;
      }
    }

    return bestCol;
  }

  function extractCrnsFromCells(cells) {
    if (!cells || !cells.length) return [];

    const headerRowIdx = detectHeaderRowIndex(cells);
    const crnCol = findCrnColumnIndex(cells, headerRowIdx);
    if (crnCol === -1) return [];

    const crns = [];
    for (let r = headerRowIdx + 1; r < cells.length; r++) {
      const raw = String((cells[r] || [])[crnCol] || "").trim();
      const match = raw.match(/\b\d{4,6}\b/);
      if (match) crns.push(match[0]);
    }

    return [...new Set(crns)];
  }

  function renderCrnResults(crns, container) {
  if (!container) return;
  if (!crns.length) {
    container.innerHTML = `<div class="text-slate-500 text-xs">No CRNs detected yet.</div>`;
    return;
  }

  container.innerHTML = `
    <div class="font-semibold mb-1">Detected CRNs (${crns.length})</div>
    <ul class="list-disc pl-5 space-y-1">
      ${crns.map((c) => `<li>${c}</li>`).join("")}
    </ul>
  `;
}


// ===============================
// OPTIMIZER: LOCK CRNs -> FIND EASIER SWAPS

// ===============================
function getRegisteredSectionsFromCrns(crns) {
  const set = new Set((crns || []).map((c) => String(c).trim()));
  const liveSections =
    (window.sections && window.sections.length)
      ? window.sections
      : (typeof sections !== "undefined" ? sections : []);
  return liveSections.filter((sec) => set.has(String(sec.crn).trim()));
}

function inferTimeWindow(registeredSections) {
  const windowByDay = {};
  registeredSections.forEach((sec) => {
    (sec.timeSlots || []).forEach((ts) => {
      const day = ts.day;
      if (!windowByDay[day]) {
        windowByDay[day] = { startMin: ts.startMin, endMin: ts.endMin };
      } else {
        windowByDay[day].startMin = Math.min(windowByDay[day].startMin, ts.startMin);
        windowByDay[day].endMin = Math.max(windowByDay[day].endMin, ts.endMin);
      }
    });
  });
  return windowByDay;
}

function isWithinWindow(section, windowByDay) {
  const slots = section.timeSlots || [];
  if (!slots.length) return false;
  return slots.every((ts) => {
    const w = windowByDay[ts.day];
    if (!w) return false;
    return ts.startMin >= w.startMin && ts.endMin <= w.endMin;
  });
}

function findEasierAlternatives(currentSec, windowByDay) {
  const map = (window.sectionsByCourseKey && window.sectionsByCourseKey.size) ? window.sectionsByCourseKey : (typeof sectionsByCourseKey !== 'undefined' ? sectionsByCourseKey : null);
  const pool = map && map.get ? (map.get(currentSec.courseKey) || []) : [];
  return pool
    .filter((s) => String(s.crn) !== String(currentSec.crn))
    .filter((s) => isWithinWindow(s, windowByDay))
    .filter((s) => (s.difficultyPercent ?? 100) < (currentSec.difficultyPercent ?? 100))
    .sort((a, b) => (a.difficultyPercent ?? 0) - (b.difficultyPercent ?? 0));
}

function categorizeSwaps(alts) {
  const available = [];
  const waitlist = [];
  alts.forEach((s) => {
    if (!s.isFull && (s.seatsRem ?? 0) > 0) available.push(s);
    else if (s.wlChance && (s.wlChance.label === "High" || s.wlChance.label === "Very High")) {
      waitlist.push(s);
    }
  });
  return { available, waitlist };
}

function formatMin(mins) {
  const h24 = Math.floor(mins / 60);
  const m = mins % 60;
  const ampm = h24 >= 12 ? "PM" : "AM";
  const h12 = ((h24 + 11) % 12) + 1;
  return `${h12}:${String(m).padStart(2, "0")} ${ampm}`;
}

function summarizeWindow(windowByDay) {
  const order = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
  const parts = [];
  order.forEach((d) => {
    if (windowByDay[d]) {
      parts.push(`${d} ${formatMin(windowByDay[d].startMin)}–${formatMin(windowByDay[d].endMin)}`);
    }
  });
  return parts.join(", ");
}

function renderOptimizerRecommendations(results, windowByDay) {
  const holder = document.getElementById("optimizerRecommendations");
  if (!holder) return;

  if (!results.length) {
    holder.innerHTML = `<div class="text-slate-500">No matching registered courses found for those CRNs.</div>`;
    return;
  }

  const windowText = summarizeWindow(windowByDay);
  holder.innerHTML = `
    <div class="mt-2 text-xs text-slate-500">Inferred target window: ${windowText || "—"}</div>
    <div class="mt-3 space-y-3">
      ${results.map((r) => {
        const cur = r.current;
        const avail = r.available.slice(0, 3);
        const wl = r.waitlist.slice(0, 3);

        const availHtml = avail.length
          ? avail.map((s) => `
              <li class="flex items-center justify-between gap-2">
                <span>${s.courseKey} · CRN ${s.crn} · ${s.meetingDays} ${s.meetingTime}</span>
                <span class="text-emerald-700 font-semibold">${s.difficultyLabel || "Easier"}</span>
              </li>
            `).join("")
          : `<li class="text-slate-500">No easier open sections in-window.</li>`;

        const wlHtml = wl.length
          ? wl.map((s) => `
              <li class="flex items-center justify-between gap-2">
                <span>${s.courseKey} · CRN ${s.crn} · ${s.meetingDays} ${s.meetingTime}</span>
                <span class="text-indigo-700 font-semibold">Waitlist ${s.wlChance.percent}% (${s.wlChance.label})</span>
              </li>
            `).join("")
          : `<li class="text-slate-500">No strong waitlist options in-window.</li>`;

        return `
          <div class="rounded-2xl border border-slate-200/70 bg-white p-3">
            <div class="text-sm font-semibold text-slate-800">${cur.courseKey} · Current CRN ${cur.crn}</div>
            <div class="text-xs text-slate-500 mt-0.5">${cur.meetingDays} ${cur.meetingTime} · ${cur.instructor || "TBA"} · ${cur.difficultyLabel || "—"}</div>

            <div class="mt-2 text-xs font-semibold text-slate-700">Easier open swaps</div>
            <ul class="mt-1 text-xs list-disc pl-5 space-y-1">${availHtml}</ul>

            <div class="mt-2 text-xs font-semibold text-slate-700">High‑chance waitlist swaps</div>
            <ul class="mt-1 text-xs list-disc pl-5 space-y-1">${wlHtml}</ul>
          </div>
        `;
      }).join("")}
    </div>
  `;
}

async function analyzeLockedSchedule(crns) {
  // Ensure core data exists
  if (!window.dataLoaded) await window.loadData();

  const registeredSecs = getRegisteredSectionsFromCrns(crns);
  const windowByDay = inferTimeWindow(registeredSecs);

  const results = registeredSecs.map((cur) => {
    const alts = findEasierAlternatives(cur, windowByDay);
    const { available, waitlist } = categorizeSwaps(alts);
    return { current: cur, available, waitlist };
  });

  renderOptimizerRecommendations(results, windowByDay);

  // Build a lightweight summary for AI Chat (safe to ignore by UI callers)
  const diffPercents = registeredSecs
    .map(s => (s.difficultyBucket && typeof s.difficultyBucket.percent === "number") ? s.difficultyBucket.percent : null)
    .filter(v => v != null);
  const avgDiff = diffPercents.length
    ? diffPercents.reduce((a,b)=>a+b,0) / diffPercents.length
    : null;

  let diffLabel = "Unknown";
  if (avgDiff != null) {
    diffLabel = avgDiff >= 75 ? "Demanding"
      : avgDiff >= 55 ? "Challenging"
      : avgDiff >= 35 ? "Moderate"
      : "Easy";
  }

  const wlCounts = {};
  registeredSecs.forEach(s => {
    const bucket = s.wlEstimate?.bucket || "Unknown";
    wlCounts[bucket] = (wlCounts[bucket] || 0) + 1;
  });

  const swapCounts = results.reduce((acc, r) => {
    acc.available += (r.available || []).length;
    acc.waitlist += (r.waitlist || []).length;
    return acc;
  }, { available: 0, waitlist: 0 });

  return {
    registeredSecs,
    windowByDay,
    results,
    summary: {
      avgDiffPercent: avgDiff,
      avgDiffLabel: diffLabel,
      wlCounts,
      swapCounts
    }
  };
}

// Expose analyzer globally for AI Chat + Optimizer
window.analyzeLockedSchedule = analyzeLockedSchedule;



// Expose for optimizer click handler



  function initScheduleOptimizer() {
  const fileInput  = document.getElementById("optimizerFileInput");
  const dropzone   = document.getElementById("optimizerDropzone");
  const pasteBtn   = document.getElementById("optimizerPasteBtn");
  const previewBox = document.getElementById("optimizerPreview");
  const crnResults = document.getElementById("optimizerCrnResults");
  const lockBtn    = document.getElementById("lockCrnsBtn");

  if (!fileInput || !dropzone || !pasteBtn || !previewBox) {
    return;
  }

  let detectedCrns = [];

  function showMessage(msg) {
    previewBox.innerHTML = `
      <div class="text-[0.8rem] text-slate-500 text-center px-4 py-8">
        ${msg}
      </div>
    `;
    if (crnResults) crnResults.innerHTML = "";
    if (lockBtn) lockBtn.disabled = true;
  }

  async function runCrnOcr(blob) {
    if (crnResults) {
      crnResults.innerHTML = `<div class="text-slate-500">Scanning for CRNs…</div>`;
    }
    if (lockBtn) lockBtn.disabled = true;

    try {
      const cells = await extractTableFromImage(blob, 5, 3);
      detectedCrns = extractCrnsFromCells(cells);
      renderCrnResults(detectedCrns, crnResults);

      if (lockBtn) lockBtn.disabled = detectedCrns.length === 0;

      console.log("[Optimizer] OCR cells:", cells);
      console.log("[Optimizer] Detected CRNs:", detectedCrns);
    } catch (err) {
      console.error("[Optimizer OCR error]", err);
      if (crnResults) {
        crnResults.innerHTML = `<div class="text-red-600">OCR failed. Try a clearer screenshot.</div>`;
      }
      if (lockBtn) lockBtn.disabled = true;
    }
  }

  function setPreviewFromBlob(blob, label) {
    if (!blob || !blob.type || !blob.type.startsWith("image/")) {
      showMessage("That doesn’t look like an image. Try again.");
      return;
    }

    const reader = new FileReader();
    reader.onload = (e) => {
      const src = e.target.result;
      previewBox.innerHTML = `
        <div class="relative w-full max-h-[420px] overflow-hidden rounded-2xl border border-slate-200/80 bg-slate-50">
          <img
            src="${src}"
            alt="${label || "Uploaded schedule"}"
            class="block w-full h-full object-contain bg-slate-900/5"
          />
        </div>
        <p class="mt-2 text-[0.7rem] text-slate-500 text-center">
          ${label ? label + " · " : ""}Preview only – we&#39;ll use this to detect classes and times.
        </p>
      `;

      runCrnOcr(blob);
    };
    reader.onerror = () =>
      showMessage("We couldn’t read that image. Try again or use a different file.");
    reader.readAsDataURL(blob);
  }

  function handleFiles(files, sourceLabel) {
    if (!files || !files.length) return;
    const file = files[0];
    setPreviewFromBlob(file, sourceLabel);
  }

  // File input (click / pick)
  fileInput.addEventListener("change", (e) => {
    handleFiles(e.target.files, "Selected from device");
  });

  // Drag & drop
  function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
  }

  ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
    dropzone.addEventListener(eventName, preventDefaults);
  });

  ["dragenter", "dragover"].forEach((eventName) => {
    dropzone.addEventListener(eventName, () => {
      dropzone.classList.add("ring-2", "ring-brand-400", "ring-offset-2");
    });
  });

  ["dragleave", "drop"].forEach((eventName) => {
    dropzone.addEventListener(eventName, () => {
      dropzone.classList.remove("ring-2", "ring-brand-400", "ring-offset-2");
    });
  });

  dropzone.addEventListener("drop", (e) => {
    const dt = e.dataTransfer;
    if (!dt || !dt.files || !dt.files.length) {
      showMessage("No files found in drop. Try again or use the upload button.");
      return;
    }
    handleFiles(dt.files, "Dropped from desktop");
  });

  // Clipboard paste button
  pasteBtn.addEventListener("click", async () => {
    if (!navigator.clipboard || !navigator.clipboard.read) {
      showMessage("Clipboard image paste isn’t supported in this browser. Try Ctrl/Cmd + V instead.");
      return;
    }
    try {
      const items = await navigator.clipboard.read();
      for (const item of items) {
        for (const type of item.types) {
          if (type.startsWith("image/")) {
            const blob = await item.getType(type);
            setPreviewFromBlob(blob, "Pasted from clipboard");
            return;
          }
        }
      }
      showMessage("We didn’t find an image in your clipboard. Copy a screenshot first and then try again.");
    } catch (err) {
      console.error("Clipboard read failed", err);
      showMessage("We couldn’t read from your clipboard. Try using the upload button instead.");
    }
  });

  // Global paste handler
  document.addEventListener("paste", (e) => {
    const cd = e.clipboardData;
    if (!cd) return;
    const items = cd.items || [];
    for (let i = 0; i < items.length; i++) {
      const item = items[i];
      if (item.kind === "file" && item.type && item.type.startsWith("image/")) {
        const file = item.getAsFile();
        if (file) {
          setPreviewFromBlob(file, "Pasted from clipboard");
          e.preventDefault();
        }
        break;
      }
    }
  });

  // Lock & Analyze
  if (lockBtn) {
    lockBtn.addEventListener("click", () => {
  if (!detectedCrns.length) return;
  const fn = window.analyzeLockedSchedule || (typeof analyzeLockedSchedule === "function" ? analyzeLockedSchedule : null);
  if (typeof fn !== "function") {
    console.warn("[Optimizer] analyzeLockedSchedule not available yet.");
    const holder = document.getElementById("optimizerRecommendations");
    if (holder) holder.innerHTML = `<div class="text-red-600 text-xs">Analyzer not ready. Reload and try again.</div>`;
    return;
  }
  fn(detectedCrns);
});
  }
}


    // === AI Chat Assistant (Builder & Optimizer wrapper) ===
    const aiChatState = {
      mode: null, // "build" | "optimize"
      step: "askMode",
      data: {
        courses: [],
        crns: []
      }
    };

    async function aiChatParseAdvisementPdf(file) {
      const { courses, sectionText } = await extractCoursesFromPdfFile(file, {
        pdfjs: pdfjsLib,
        startMarker: "Part 2: Desired Course Selection",
        endMarker: "Part 2A",
      });
      const parsed = (courses || []).map(parseCourseLineToObject).filter(Boolean);

      // Keep builder state in sync so the regular Schedule Builder panel can reuse it
      if (typeof builderDetectedCoursesRaw !== "undefined") {
        builderDetectedCoursesRaw = courses || [];
      }
      if (typeof builderParsedCourses !== "undefined") {
        builderParsedCourses = parsed || [];
      }

      return { courses: courses || [], parsed, sectionText };
    }

    async function aiChatGenerateSchedulesFromParsedCourses() {
      try {
        if (typeof loadData === "function") {
          await loadData();
        }

        if (!builderParsedCourses || !builderParsedCourses.length) {
          return null;
        }

        const namedCourses = builderParsedCourses.filter(
          (c) => c.type === "named" && c.courseKey
        );
        const placeholders = builderParsedCourses.filter(
          (c) => c.type === "placeholder" || !c.courseKey
        );

        if (!namedCourses.length) {
          return { courseEntries: [], chosen: [], placeholders };
        }

        const courseEntries = [];
        namedCourses.forEach((course) => {
          const sectionsForCourse = sectionsByCourseKey.get(course.courseKey) || [];
          if (!sectionsForCourse.length) return;

          const scored = sectionsForCourse.map((sec) => {
            const score = scoreSectionOverall(sec);
            return { section: sec, score };
          });

          scored.sort((a, b) => b.score.total - a.score.total);

          courseEntries.push({
            course,
            candidates: scored.slice(0, 8),
          });
        });

        if (!courseEntries.length) {
          return { courseEntries: [], chosen: [], placeholders };
        }

        const chosen = buildGreedySchedule(courseEntries);
        // Render into the regular Schedule Builder results container
        renderScheduleOptions({ courseEntries, chosen, placeholders });

        return { courseEntries, chosen, placeholders };
      } catch (err) {
        console.error("[AI Chat] schedule generation failed", err);
        return null;
      }
    }

    async function aiChatExtractCrnsFromImage(blob) {
      const cells = await extractTableFromImage(blob);
      const crns = extractCrnsFromCells(cells);
      return crns || [];
    }

    function initAiChat() {
      const messagesEl = document.getElementById("aiChatMessages");
      const inputEl = document.getElementById("aiChatInput");
      const sendBtn = document.getElementById("aiChatSendBtn");
      const chipsEl = document.getElementById("aiChatChips");
      const uploadBtn = document.getElementById("aiChatUploadBtn");
      const fileInput = document.getElementById("aiChatFileInput");

      if (!messagesEl || !inputEl || !sendBtn || !chipsEl || !uploadBtn || !fileInput) {
        return;
      }

      
      
      // Unified AI Chat message system
      const aiChatMessages = [];

      // --- AI Chat helpers: inline markdown + FontAwesome normalization ---
      function escapeHtml(str) {
        return String(str)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function renderInlineMarkdown(text) {
        const esc = escapeHtml(text || "");
        // bold: **text**
        return esc
          .replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>")
          .replace(/\n/g, "<br>");
      }

      function normalizeFa(iconClass) {
        if (!iconClass) return "";
        // keep brand icons as-is; otherwise default to solid
        if (iconClass.includes("fa-brands")) return iconClass;
        return iconClass.replace(/\bfa-regular\b|\bfa-light\b|\bfa-thin\b|\bfa-duotone\b/g, "fa-solid");
      }

      
      function formatMinutesToTime(mins) {
        mins = Math.max(0, parseInt(mins || 0, 10));
        const h24 = Math.floor(mins / 60);
        const m = mins % 60;
        const ampm = h24 >= 12 ? "PM" : "AM";
        let h12 = h24 % 12;
        if (h12 === 0) h12 = 12;
        return `${h12}:${m.toString().padStart(2,"0")} ${ampm}`;
      }

      function attachCustomTimeSlider() {
        const startEl = document.getElementById("customTimeStart");
        const endEl   = document.getElementById("customTimeEnd");
        const startLb = document.getElementById("customTimeStartLabel");
        const endLb   = document.getElementById("customTimeEndLabel");
        if (!startEl || !endEl || !startLb || !endLb) return;

        function syncLabels() {
          startLb.textContent = formatMinutesToTime(startEl.value);
          endLb.textContent   = formatMinutesToTime(endEl.value);
        }

        startEl.addEventListener("input", () => {
          if (parseInt(startEl.value,10) >= parseInt(endEl.value,10)) {
            startEl.value = parseInt(endEl.value,10) - 30;
          }
          syncLabels();
        });

        endEl.addEventListener("input", () => {
          if (parseInt(endEl.value,10) <= parseInt(startEl.value,10)) {
            endEl.value = parseInt(startEl.value,10) + 30;
          }
          syncLabels();
        });

        syncLabels();
      }


      function renderMessageInner(msg) {
        const frag = document.createDocumentFragment();

        // Text or HTML content
        if (msg.type === "text" || msg.type === "choices") {
          if (msg.html) {
            const div = document.createElement("div");
            div.className = "text-[0.85rem] leading-relaxed whitespace-pre-wrap";
            div.innerHTML = msg.html;
            frag.appendChild(div);
          } else if (msg.text) {
            const p = document.createElement("p");
            p.className = "text-[0.85rem] leading-relaxed whitespace-pre-wrap";
            p.innerHTML = renderInlineMarkdown(msg.text);
            frag.appendChild(p);
          }
        } else if (msg.type === "cardsHtml") {
          const div = document.createElement("div");
          div.className = "space-y-2 text-[0.85rem] leading-relaxed";
          div.innerHTML = msg.html || "";
          frag.appendChild(div);
        } else if (msg.type === "file") {
          const label = document.createElement("p");
          label.className = "text-[0.75rem] uppercase tracking-wide text-slate-500 dark:text-slate-400";
          label.textContent = msg.text || "File uploaded";
          frag.appendChild(label);

          if (msg.file && msg.file.kind === "image") {
            const img = document.createElement("img");
            img.src = msg.file.url;
            img.alt = msg.file.name || "Uploaded image";
            img.className =
              "mt-1 max-h-56 w-auto rounded-xl border border-slate-200/70 dark:border-slate-700/70 object-contain";
            frag.appendChild(img);
          } else if (msg.file) {
            const box = document.createElement("div");
            box.className =
              "mt-1 flex items-center gap-2 rounded-xl border border-slate-200/70 dark:border-slate-700/70 " +
              "bg-slate-50/80 dark:bg-slate-900/50 px-3 py-2";
            const name = document.createElement("div");
            name.className = "text-[0.8rem]";
            name.textContent = msg.file.name || "Uploaded file";
            box.appendChild(name);
            frag.appendChild(box);
          }
        }

        // Actions / buttons (for choices & similar)
        const actions = msg.actions || [];
        if (actions.length) {
          const row = document.createElement("div");
          row.className = "mt-2 flex flex-wrap gap-2";

          actions.forEach((action) => {
            const btn = document.createElement("button");
            btn.type = "button";
            const variant = action.variant || "pill";

            if (variant === "tile") {
              btn.className =
                "flex-1 min-w-[220px] max-w-sm flex items-center justify-between gap-3 " +
                "rounded-2xl border border-slate-200 bg-white px-4 py-3 shadow-sm " +
                "hover:border-sky-400 hover:shadow-md transition text-[0.8rem]";
            } else {
              btn.className =
                "inline-flex items-center gap-2 rounded-full border border-sky-500/70 " +
                "bg-sky-50/80 text-[0.75rem] font-medium text-sky-800 dark:text-sky-100 " +
                "px-3 py-1.5 hover:bg-sky-100/80 dark:bg-sky-950/40 dark:border-sky-700/70";
            }

            btn.dataset.actionId = action.id || action.value;
            if (action.icon) {
              const iconSpan = document.createElement("span");
              iconSpan.className = "inline-flex h-5 w-5 items-center justify-center rounded-full bg-sky-100 text-sky-700";
              const iconClass = normalizeFa(action.icon);
              iconSpan.innerHTML = `<i class="${iconClass} text-[0.7rem]"></i>`;
              btn.appendChild(iconSpan);
            }
            const span = document.createElement("span");
            span.textContent = action.label || action.text || "";
            btn.appendChild(span);

            if (action.description && variant === "tile") {
              const desc = document.createElement("span");
              desc.className = "block text-[0.7rem] text-slate-600 text-left";
              desc.textContent = action.description;
              btn.appendChild(desc);
            }

            row.appendChild(btn);
          });

          frag.appendChild(row);
        }

        return frag;
      }

      function renderMessageCard(msg) {
        const wrapper = document.createElement("div");
        wrapper.className =
          msg.role === "user"
            ? "flex justify-end"
            : "flex justify-start";

        const card = document.createElement("div");
        card.className =
          "max-w-[90%] md:max-w-[75%] rounded-2xl border shadow-sm px-3 py-2 " +
          (msg.role === "user"
            ? "bg-sky-500 text-white border-sky-500"
            : "bg-white text-slate-900 border-slate-200/70");

        card.appendChild(renderMessageInner(msg));
        wrapper.appendChild(card);
        return wrapper;
      }

      function renderMessages() {
        // Determine the index of the last assistant message so only that one animates
        let lastAssistantIndex = -1;
        aiChatMessages.forEach((msg, i) => {
          if (msg.role === "assistant") lastAssistantIndex = i;
        });

        messagesEl.innerHTML = "";
        aiChatMessages.forEach((msg, index) => {
          const el = renderMessageCard(msg);

          // Apply a quick enter animation to the newest assistant message on each render
          if (index === lastAssistantIndex && msg.role === "assistant") {
            el.classList.add("ai-msg-enter");
          }

          messagesEl.appendChild(el);
        });

        // Auto-scroll the scrollable container (the element with .ai-chat-scroll)
        const scrollContainer = messagesEl.closest('.ai-chat-scroll');
        if (scrollContainer) {
          const target = scrollContainer.scrollHeight;
          if (scrollContainer.scrollTo) {
            scrollContainer.scrollTo({ top: target, behavior: "smooth" });
          } else {
            scrollContainer.scrollTop = target;
          }
        }
      }

      function addMessage(msg) {
        const full = {
          id: `m_${Date.now()}_${Math.random().toString(36).slice(2)}`,
          role: msg.role || "assistant",
          type: msg.type || "text",
          text: msg.text || "",
          html: msg.html || null,
          actions: msg.actions || null,
          file: msg.file || null,
          meta: msg.meta || { timestamp: Date.now() },
        };
        aiChatMessages.push(full);
        renderMessages();
        return full;
      }

      function pushMessage(role, text, opts = {}) {
        const isCards = opts && opts.variant === "cards" && role !== "user";
        const msg = {
          role,
          type: isCards ? "cardsHtml" : "text",
        };

        if (opts && opts.html) {
          msg.html = text;
          msg.text = "";
        } else {
          msg.text = text;
          msg.html = null;
        }

        addMessage(msg);
      }

      function pushAttachment(role, file, { label } = {}) {
        if (!file) return;
        const isImage = file.type && file.type.startsWith("image/");
        const blobUrl = URL.createObjectURL(file);
        addMessage({
          role,
          type: "file",
          text: label || "File uploaded",
          file: {
            kind: isImage ? "image" : "file",
            name: file.name,
            url: blobUrl,
          },
        });
      }

      function setChips(chips) {
        const list = chips || [];
        if (!list.length) {
          return;
        }

        const actions = list.map((chip) => ({
          id: chip.value,
          value: chip.value,
          label: chip.label,
          icon: chip.icon || null,
          variant: chip.variant || "pill",
          description: chip.description || null,
        }));

        // Attach actions to the last assistant message if possible
        let target = null;
        for (let i = aiChatMessages.length - 1; i >= 0; i--) {
          const msg = aiChatMessages[i];
          if (msg.role === "assistant") {
            target = msg;
            break;
          }
        }

        if (target && (target.type === "text" || target.type === "cardsHtml") && !target.actions) {
          target.type = "choices";
          target.actions = actions;
        } else {
          aiChatMessages.push({
            id: `m_${Date.now()}_${Math.random().toString(36).slice(2)}`,
            role: "assistant",
            type: "choices",
            text: "",
            html: null,
            actions,
            file: null,
            meta: { timestamp: Date.now() },
          });
        }

        renderMessages();
      }

function resetState() {
        aiChatState.mode = null;
        aiChatState.step = "askMode";
        aiChatState.data = { courses: [], crns: [] };
      }

      function summarizeWindowByDay(windowByDay) {
        if (!windowByDay || !Object.keys(windowByDay).length) return "";
        const dayOrder = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
        const parts = [];
        dayOrder.forEach((d) => {
          const w = windowByDay[d];
          if (!w) return;
          if (typeof minutesToDisplay === "function") {
            parts.push(`${d} ${minutesToDisplay(w.startMin)}–${minutesToDisplay(w.endMin)}`);
          } else {
            parts.push(d);
          }
        });
        return parts.join(", ");
      }

      function setTimePrefsFromPreset(preset) {
        try {
          if (typeof timePrefsModel === "undefined") return;
          let days;
          let start;
          let end;
          if (preset === "standard") {
            days = ["Mon","Tue","Wed","Thu"];
            start = 9 * 60;
            end = 16 * 60;
          } else if (preset === "morning") {
            days = ["Mon","Tue","Wed","Thu","Fri"];
            start = 8 * 60;
            end = 13 * 60;
          } else if (preset === "evening") {
            days = ["Mon","Tue","Wed","Thu"];
            start = 12 * 60;
            end = 21 * 60;
          } else {
            return;
          }

          if (typeof setSelectedDays === "function") {
            setSelectedDays(days);
          } else {
            timePrefsModel.selectedDays = new Set(days);
          }

          if (typeof setDefaultWindow === "function") {
            setDefaultWindow(start, end);
          } else {
            timePrefsModel.defaultWindow = { start, end };
          }

          // Clear any per-day overrides so the preset is clean
          if (timePrefsModel.dayOverrides) {
            timePrefsModel.dayOverrides = {};
          }

          if (typeof syncDayButtons === "function") {
            syncDayButtons();
          }
          if (typeof syncCustomRows === "function") {
            syncCustomRows();
          }
          if (typeof renderTimeGrid === "function") {
            renderTimeGrid();
          }
        } catch (e) {
          console.error("[AI Chat] Failed to apply time preset", e);
        }
      }

      function askForTimePrefsForBuild() {
        pushMessage(
          "assistant",
          "Before I build schedules, choose what times you prefer for classes."
        );
        setChips([
          { label: "Standard daytime (9am–4pm, Mon–Thu)", value: "time_build_standard" },
          { label: "Morning‑heavy (8am–1pm, Mon–Fri)", value: "time_build_morning" },
          { label: "Afternoons / evenings (12pm–9pm, Mon–Thu)", value: "time_build_evening" },
          { label: "Custom time window", value: "time_build_custom" }
        ]);
      }

      function askForTimePrefsForOptimize() {
        const crns = aiChatState.data.crns || [];
        let summary = "";
        try {
          if (
            typeof getRegisteredSectionsFromCrns === "function" &&
            typeof inferTimeWindow === "function" &&
            crns.length
          ) {
            const registered = getRegisteredSectionsFromCrns(crns);
            const windowByDay = inferTimeWindow(registered);
            const human = summarizeWindowByDay(windowByDay);
            if (human) {
              summary = `Based on your current classes, your main time window looks like: ${human}.`;
            }
          }
        } catch (e) {
          console.warn("[AI Chat] Could not summarize optimizer window", e);
        }
        if (!summary) {
          summary =
            "I can infer a time window from your current classes and use that when suggesting swaps.";
        }
        pushMessage(
          "assistant",
          summary +
            "\n\nDoes that general time pattern look okay for finding swaps, or should I just analyze without worrying about it?"
        );
        setChips([
          { label: "That looks fine", value: "opt_window_ok" },
          { label: "Just analyze my schedule", value: "opt_window_skip" }
        ]);
      }

      function askForMode() {
        resetState();
        pushMessage(
          "assistant",
          "Hey! I can either help you **build a new schedule** from your advisement sheet or **optimize a schedule you already have**.\n\nWhat would you like to do?");
        setChips([
          {
            label: "Build a schedule",
            value: "mode_build",
            variant: "tile",
            icon: "fa-regular fa-calendar-plus"
          },
          {
            label: "Optimize existing schedule",
            value: "mode_optimize",
            variant: "tile",
            icon: "fa-regular fa-wand-magic-sparkles"
          },
        ]);
      }

      function askForPdf() {
        pushMessage(
          "assistant",
          "Great — to build a schedule, please upload your **Advisement Sheet PDF**. Your file stays in your browser."
        );
        setChips([]);
      }

      function askForImage() {
        pushMessage(
          "assistant",
          "Got it — to optimize your current schedule, upload or paste a **screenshot of your schedule** (with CRNs visible)."
        );
        setChips([]);
      }

      async function handleFile(file) {
        if (!file) return;

        if (aiChatState.mode === "build" && aiChatState.step === "awaitPdf") {
          if (file.type !== "application/pdf") {
            pushMessage("assistant", "That doesn’t look like a PDF. Try uploading your advisement sheet as a PDF.");
            return;
          }
          pushAttachment("user", file, { label: "Uploaded advisement sheet" });
          pushMessage("assistant", "Nice, let me read your advisement sheet and pull out the courses…");

          try {
            const result = await aiChatParseAdvisementPdf(file);
            aiChatState.data.courses = result.courses;

            if (!result.courses.length) {
              pushMessage(
                "assistant",
                "I couldn’t detect any numbered courses in the “Part 2: Desired Course Selection” section. Double‑check that this is the right advisement form."
              );
              return;
            }

            const previewList =
              result.courses.length > 8
                ? result.courses.slice(0, 8).join(", ") + `, and ${result.courses.length - 8} more…`
                : result.courses.join(", ");

            pushMessage(
              "assistant",
              `Here’s what I found:\n\n${previewList}\n\nDoes that look right, or do you want to edit the course list?`
            );
            aiChatState.step = "confirmCourses";
            setChips([
              { label: "Looks good", value: "courses_ok" },
              { label: "Edit courses", value: "courses_edit" },
            ]);
          } catch (err) {
            console.error("[AI Chat] PDF parse error", err);
            pushMessage(
              "assistant",
              "Something went wrong while reading that PDF. Try again with the same file, or a clearer scan if you have one."
            );
          }
        } else if (aiChatState.mode === "optimize" && aiChatState.step === "awaitImage") {
          if (!file.type.startsWith("image/")) {
            pushMessage("assistant", "That doesn’t look like an image. Try uploading a screenshot instead.");
            return;
          }
          pushAttachment("user", file, { label: "Uploaded screenshot" });
          pushMessage("assistant", "Nice, I’ll scan the screenshot and look for CRNs…");

          try {
            const crns = await aiChatExtractCrnsFromImage(file);
            aiChatState.data.crns = crns;

            if (!crns.length) {
              pushMessage(
                "assistant",
                "I couldn’t detect any CRNs in that screenshot. Try a clearer screenshot where the CRN column is fully visible."
              );
              return;
            }

            pushMessage(
              "assistant",
              `I detected these CRNs:\n\n${crns.join(", ")}\n\nDo you want me to analyze this schedule?`
            );
            aiChatState.step = "confirmCrns";
            setChips([
              { label: "Yes, analyze it", value: "crns_ok" },
              { label: "No, I’ll edit the CRNs", value: "crns_edit" },
            ]);
          } catch (err) {
            console.error("[AI Chat] image parse error", err);
            pushMessage(
              "assistant",
              "Something went wrong while reading that screenshot. Try again with a different image."
            );
          }
        }
      }

      async function runScheduleGeneration() {
        pushMessage(
          "assistant",
          "Awesome — I’ll generate a schedule using those courses and our current time‑window settings."
        );
        const result = await aiChatGenerateSchedulesFromParsedCourses();

        if (!result || !result.chosen || !result.chosen.length) {
          pushMessage(
            "assistant",
            "I couldn’t build a full schedule that fits the current constraints. You can tweak time windows in the **Schedule Builder** tab and try again."
          );
        } else {
          
  
  // Build a compact, contained card layout for chat (nested within one response block)
  const htmlParts = [];
  htmlParts.push(`
    <div class="rounded-2xl bg-white border border-slate-200/80 shadow-sm p-3 md:p-4 space-y-3 w-full">
      <div class="text-sm md:text-base font-semibold text-slate-900">
        Here’s one schedule option I put together for you:
      </div>
      <div class="space-y-1">
  `);

  result.chosen.forEach((sec, idx) => {
    htmlParts.push(
      miniSecCard(sec, { compact: true })
    );
  });

  htmlParts.push(`
      </div>
      <div class="text-[12px] md:text-sm text-slate-600 dark:text-slate-300 pt-1">
        For a full visual breakdown (including backup sections), scroll to the <b>Schedule Builder</b> section below.
      </div>
    </div>
  `);

  pushMessage("assistant", htmlParts.join(""), { html: true, variant: "cards" });
}

        aiChatState.step = "done";
        setChips([
          { label: "Start over", value: "restart" },
          { label: "Switch to Optimize", value: "switch_optimize" },
        ]);
      }

      
      async function runCrnAnalysis() {
        const crns = aiChatState.data.crns || [];
        if (!crns.length) return;

        pushMessage(
          "assistant",
          "Got it — I’ll run those CRNs through the optimizer and look for easier or safer swaps."
        );

        try {
          const fn =
            window.analyzeLockedSchedule ||
            (typeof analyzeLockedSchedule === "function" ? analyzeLockedSchedule : null);
          if (typeof fn !== "function") throw new Error("Analyzer not available");

          const analysis = await fn(crns);
          const summary = analysis?.summary;
          const results = analysis?.results || [];

          // 1) quick summary
          if (summary) {
            const wlSummary = Object.entries(summary.wlCounts || {})
              .map(([k,v]) => `${k}: ${v}`)
              .join(", ");

            pushMessage(
              "assistant",
              `Done! Here’s a quick read:
` +
              `• Overall difficulty: ${summary.avgDiffLabel}` +
              (summary.avgDiffPercent != null ? ` (~${Math.round(summary.avgDiffPercent)}%)` : "") + `
` +
              `• Waitlist risk mix: ${wlSummary || "Unknown"}
` +
              `• Swap ideas found: ${summary.swapCounts.available} open-seat, ${summary.swapCounts.waitlist} high‑chance WL swaps.`
            );
          } else {
            pushMessage(
              "assistant",
              "Done! I analyzed that schedule."
            );
          }

          
// 2) show top swap options in chat (styled like Course Search)
if (results.length) {
  const htmlParts = [];
  htmlParts.push(`
    <div class="bg-slate-50/90 dark:bg-slate-900/60 border border-slate-200 dark:border-slate-700 rounded-2xl p-3 md:p-4 space-y-3 w-full">
      <div class="text-sm md:text-base font-semibold text-slate-900 dark:text-slate-50">
        Here are the top swap ideas I found (up to 2 per course):
      </div>
      <div class="space-y-3">
  `);
results.forEach((r) => {
    const cur = r.current || {};
    const curTitle = cur.courseKey || `${cur.subject || ""} ${cur.courseNumber || ""}`.trim() || "Course";
    const avail = (r.available || []).slice(0, 2);
    const wl = (r.waitlist || []).slice(0, 2);

    htmlParts.push(`
      <div class="space-y-2 border border-slate-200 dark:border-slate-700 rounded-2xl p-2 md:p-3 bg-slate-50/70 dark:bg-slate-900/40">
        <div class="text-xs font-semibold text-slate-700 dark:text-slate-200">
          ${curTitle}
        </div>
        ${miniSecCard(cur, { label: "Current section" })}
        ${avail.length ? `
          <div class="text-[11px] font-semibold text-emerald-700 dark:text-emerald-200 mt-1">Open-seat swaps</div>
          <div class="space-y-2">
            ${avail.map((s) => miniSecCard(s, { kind: "available" })).join("")}
          </div>
        ` : ``}
        ${wl.length ? `
          <div class="text-[11px] font-semibold text-sky-700 dark:text-sky-200 mt-1">Waitlist swaps</div>
          <div class="space-y-2">
            ${wl.map((s) => miniSecCard(s)).join("")}
          </div>
        ` : ``}
        ${(!avail.length && !wl.length) ? `
          <div class="text-[12px] text-slate-600 dark:text-slate-300">No better swaps found right now.</div>
        ` : ``}
      </div>
    `);
  });

  htmlParts.push(`
      </div>
      <div class="text-[12px] md:text-sm text-slate-600 dark:text-slate-300 pt-1">
        I also filled the full detailed list in the <b>Schedule Optimizer</b> tab if you want to browse everything.
      </div>
    </div>
  `);

  pushMessage("assistant", htmlParts.join(""), { html: true, variant: "cards" });
}
 else {
            pushMessage(
              "assistant",
              "I couldn’t match those CRNs to registered sections, so no swap options to show yet."
            );
          }

        } catch (err) {
          console.error("[AI Chat] CRN analysis error", err);
          pushMessage(
            "assistant",
            "Something went wrong while running the optimizer. Try another screenshot, or use the Schedule Optimizer tab directly."
          );
        }

        aiChatState.step = "done";
        setChips([
          { label: "Start over", value: "restart" },
          { label: "Switch to Build", value: "switch_build" },
        ]);
      }
function handleChip(value) {
        if (value === "restart") {
          askForMode();
          return;
        }
        if (value === "switch_build") {
          aiChatState.mode = "build";
          aiChatState.step = "awaitPdf";
          pushMessage("user", "Let’s build a schedule instead.");
          askForPdf();
          return;
        }
        if (value === "switch_optimize") {
          aiChatState.mode = "optimize";
          aiChatState.step = "awaitImage";
          pushMessage("user", "Let’s optimize my existing schedule instead.");
          askForImage();
          return;
        }

        if (aiChatState.step === "askMode") {
          if (value === "mode_build") {
            aiChatState.mode = "build";
            aiChatState.step = "awaitPdf";
            pushMessage("user", "I want to build a schedule.");
            askForPdf();
          } else if (value === "mode_optimize") {
            aiChatState.mode = "optimize";
            aiChatState.step = "awaitImage";
            pushMessage("user", "I want to optimize my current schedule.");
            askForImage();
          }
        } else if (aiChatState.step === "confirmCourses") {
          if (value === "courses_ok") {
            aiChatState.step = "awaitTimePrefsBuild";
            askForTimePrefsForBuild();
          } else if (value === "courses_edit") {
            pushMessage(
              "assistant",
              "No problem — send me a list of courses you want to use instead (for example: `ACC 2320, MTH 1100C, ENG 1100C`)."
            );
            aiChatState.step = "editCourses";
            setChips([]);
          }
        } else if (aiChatState.step === "awaitTimePrefsBuild") {
          if (value === "time_build_standard") {
            setTimePrefsFromPreset("standard");
            pushMessage(
              "assistant",
              "Got it — I’ll use a standard daytime window (9am–4pm, Mon–Thu) when building schedules."
            );
            aiChatState.step = "generatedSchedule";
            setTimeout(() => { runScheduleGeneration(); }, 0);
          } else if (value === "time_build_morning") {
            setTimePrefsFromPreset("morning");
            pushMessage(
              "assistant",
              "Got it — I’ll aim for morning‑heavy classes (around 8am–1pm, Mon–Fri)."
            );
            aiChatState.step = "generatedSchedule";
            setTimeout(() => { runScheduleGeneration(); }, 0);
          } else if (value === "time_build_evening") {
            setTimePrefsFromPreset("evening");
            pushMessage(
              "assistant",
              "Got it — I’ll aim for afternoon / evening classes (around 12pm–9pm, Mon–Thu)."
            );
            aiChatState.step = "generatedSchedule";
            setTimeout(() => { runScheduleGeneration(); }, 0);
          } else if (value === "time_build_custom") {
            aiChatState.step = "awaitCustomTimeWindow";
            setChips([]);
            pushMessage(
              "assistant",
              `
              <div class="space-y-3">
                <p class="text-[0.9rem] font-medium text-slate-900">Choose your custom time window:</p>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                  <label class="text-xs font-semibold text-slate-600">Start time</label>
                  <label class="text-xs font-semibold text-slate-600 sm:text-right">End time</label>

                  <div class="flex items-center gap-3">
                    <input id="customTimeStart" type="range" min="420" max="1320" step="30"
                      class="w-full accent-sky-500" value="540"/>
                    <span id="customTimeStartLabel" class="text-sm font-semibold text-slate-900 whitespace-nowrap">9:00 AM</span>
                  </div>

                  <div class="flex items-center gap-3">
                    <input id="customTimeEnd" type="range" min="420" max="1320" step="30"
                      class="w-full accent-sky-500" value="960"/>
                    <span id="customTimeEndLabel" class="text-sm font-semibold text-slate-900 whitespace-nowrap">4:00 PM</span>
                  </div>
                </div>

                <div class="flex items-center justify-end pt-1">
                  <button data-action-id="time_build_custom_confirm"
                    class="inline-flex items-center gap-2 rounded-xl bg-sky-500 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-sky-600">
                    Use this window
                  </button>
                </div>
              </div>
              `,
              { html: true }
            );
            attachCustomTimeSlider();
          }
        
        } else if (aiChatState.step === "awaitCustomTimeWindow") {
          if (value === "time_build_custom_confirm") {
            const startEl = document.getElementById("customTimeStart");
            const endEl   = document.getElementById("customTimeEnd");
            const start = startEl ? parseInt(startEl.value,10) : 540;
            const end   = endEl ? parseInt(endEl.value,10) : 960;

            if (end <= start) {
              pushMessage("assistant", "End time has to be after start time. Try adjusting the sliders.");
              return;
            }

            try {
              const days =
                (typeof timePrefsModel !== "undefined" && timePrefsModel.selectedDays && timePrefsModel.selectedDays.size)
                  ? Array.from(timePrefsModel.selectedDays)
                  : ["Mon","Tue","Wed","Thu"];

              if (typeof setSelectedDays === "function") {
                setSelectedDays(days);
              } else if (typeof timePrefsModel !== "undefined") {
                timePrefsModel.selectedDays = new Set(days);
              }

              if (typeof setDefaultWindow === "function") {
                setDefaultWindow(start, end);
              } else if (typeof timePrefsModel !== "undefined") {
                timePrefsModel.defaultWindow = { start, end };
              }
            } catch (e) {}

            pushMessage(
              "assistant",
              `Perfect — I’ll build schedules within **${formatMinutesToTime(start)}–${formatMinutesToTime(end)}**.`
            );
            aiChatState.step = "generatedSchedule";
            setTimeout(() => { runScheduleGeneration(); }, 0);
          }
} else if (aiChatState.step === "confirmCrns") {
          if (value === "crns_ok") {
            aiChatState.step = "confirmOptimizeWindow";
            askForTimePrefsForOptimize();
          } else if (value === "crns_edit") {
            pushMessage(
              "assistant",
              "Okay — send me the CRNs you actually registered for (for example: `12345, 67890, 11223`)."
            );
            aiChatState.step = "editCrns";
            setChips([]);
          }
        } else if (aiChatState.step === "confirmOptimizeWindow") {
          if (value === "opt_window_ok" || value === "opt_window_skip") {
            // We don’t change the underlying optimizer logic here — it already
            // infers a time window from your CRNs. This step is just to surface
            // that to the user in the chat flow.
            setTimeout(() => { runCrnAnalysis(); }, 0);
          }
        }
      }

      function handleUserText(text) {
        if (!text) return;

        if (aiChatState.step === "editCourses") {
          const raw = text
            .split(/[,;\n]/)
            .map((t) => t.trim())
            .filter(Boolean);

          if (!raw.length) {
            pushMessage(
              "assistant",
              "I didn’t see any course codes there. Try something like `ACC 2320, MTH 1100C, ENG 1100C`."
            );
            return;
          }

          aiChatState.data.courses = raw;
          if (typeof builderDetectedCoursesRaw !== "undefined") {
            builderDetectedCoursesRaw = raw;
          }
          if (typeof builderParsedCourses !== "undefined") {
            builderParsedCourses = raw
              .map((line) => parseCourseLineToObject(line))
              .filter(Boolean);
          }

          pushMessage(
            "assistant",
            `Got it. I’ll use these courses:\n\n${raw.join(", ")}\n\nReady for me to generate a schedule with them?`
          );
          aiChatState.step = "confirmCourses";
          setChips([
            { label: "Yes, generate it", value: "courses_ok" },
            { label: "Change them again", value: "courses_edit" },
          ]);
        } else if (aiChatState.step === "editCrns") {
          const crns = text
            .split(/[,;\s]+/)
            .map((t) => t.trim())
            .filter((t) => /^\d{4,6}$/.test(t));

          if (!crns.length) {
            pushMessage(
              "assistant",
              "I didn’t see any CRNs in that message. Try something like `12345, 67890, 11223`."
            );
            return;
          }

          aiChatState.data.crns = crns;
          pushMessage(
            "assistant",
            `Perfect — I’ll use these CRNs: ${crns.join(", ")}. Want me to analyze this schedule?`
          );
          aiChatState.step = "confirmCrns";
          setChips([
            { label: "Yes, analyze it", value: "crns_ok" },
            { label: "Change them again", value: "crns_edit" },
          ]);
        } else {
          // Generic text while not in a special step
          pushMessage(
            "assistant",
            "I’ll guide you using buttons and file uploads here. To restart, tap **Start over**."
          );
        }
      }

      sendBtn.addEventListener("click", () => {
        const text = inputEl.value.trim();
        if (!text) return;
        pushMessage("user", text);
        inputEl.value = "";
        handleUserText(text);
      });

      inputEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendBtn.click();
        }
      });

      uploadBtn.addEventListener("click", () => {
        fileInput.click();
      });

      fileInput.addEventListener("change", (e) => {
        const file = e.target.files && e.target.files[0];
        if (file) {
          handleFile(file);
        }
        // Reset value so uploading the same file again still fires change
        e.target.value = "";
      });

      
      messagesEl.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-action-id]");
        if (!btn) return;
        const actionId = btn.dataset.actionId;
        if (typeof handleChip === "function") {
          handleChip(actionId);
        }
      });

// Start the conversation
      askForMode();
    }


// kick off nav + time preferences + initial data load
    document.addEventListener("DOMContentLoaded", () => {
      initSpaNav();
      initTimePrefsUI();
      loadData();
      initScheduleOptimizer();
      initAiChat();
    });
  </script>
</body>
</html>
